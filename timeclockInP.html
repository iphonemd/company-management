<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CleanPro - Time Clock</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßπ</text></svg>">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0d9488">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CleanPro">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßπ</text></svg>">
  <link rel="manifest" href="manifest.json">
  
  <style>
    .timeclock-layout {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
    }
    
    /* Sticky header with date/time - REDESIGNED */
    .timeclock-header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: var(--space-3) var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .header-date-time {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    
    .header-date {
      font-size: var(--text-sm);
      opacity: 0.9;
    }
    
    .header-time {
      font-size: var(--text-xl);
      font-weight: 700;
      font-family: 'Outfit', sans-serif;
    }
    
    .timeclock-header-actions {
      display: flex;
      gap: var(--space-2);
    }
    
    .timeclock-header-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-size: var(--text-lg);
      transition: background var(--transition-fast);
    }
    
    .timeclock-header-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Team selector dropdown - NEW */
    .team-selector {
      position: sticky;
      top: 56px;
      z-index: 99;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      margin: 0 var(--space-4);
      margin-top: var(--space-2);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }
    
    .team-selector-btn {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border: none;
      color: white;
      font-size: var(--text-base);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .team-selector-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .team-selector-arrow {
      transition: transform 0.3s ease;
    }
    
    .team-selector.open .team-selector-arrow {
      transform: rotate(180deg);
    }
    
    .team-members-dropdown {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(255,255,255,0.1);
    }
    
    .team-selector.open .team-members-dropdown {
      max-height: 300px;
    }
    
    .team-member-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .team-member-item:last-child {
      border-bottom: none;
    }
    
    .team-member-avatar-sm {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: var(--text-xs);
    }
    
    .team-member-info-sm {
      flex: 1;
      color: white;
    }
    
    .team-member-name-sm {
      font-weight: 500;
      font-size: var(--text-sm);
    }
    
    .team-member-role-sm {
      font-size: var(--text-xs);
      opacity: 0.7;
    }
    
    .team-member-status-sm {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.4);
    }
    
    .team-member-status-sm.active {
      background: var(--success-400);
    }

    /* Admin info banner - NEW */
    .admin-info-banner {
      background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
      border: 1px solid var(--primary-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      text-align: center;
      color: var(--primary-800);
      font-size: var(--text-sm);
    }
    
    /* Admin quick actions - NEW */
    .admin-quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    
    .admin-quick-btn {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      color: var(--gray-700);
    }
    
    .admin-quick-btn:hover {
      background: var(--gray-50);
      border-color: var(--primary-300);
    }
    
    .admin-quick-btn-icon {
      font-size: var(--text-xl);
    }
    
    .admin-quick-btn-text {
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .schedule-nav-btn {
      background: rgba(13,148,136,0.08);
      border: 1px solid rgba(13,148,136,0.12);
      color: var(--primary-600);
      border-radius: var(--radius-lg);
      padding: 6px 8px;
      cursor: pointer;
      font-size: var(--text-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    .schedule-nav-btn:hover { background: rgba(13,148,136,0.12); }
    
    .timeclock-content {
      padding: var(--space-4);
    }
    
    .status-card {
      background: white;
      border-radius: var(--radius-2xl);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-xl);
    }
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-dot.clocked-out { background: var(--gray-400); animation: none; }
    .status-dot.clocked-in { background: var(--success-500); }
    .status-dot.on-job { background: var(--warning-500); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    .status-text { font-weight: 600; font-size: var(--text-base); }
    .status-text.clocked-out { color: var(--gray-500); }
    .status-text.clocked-in { color: var(--success-600); }
    .status-text.on-job { color: var(--warning-600); }
    
    .hours-today { text-align: right; }
    .hours-today-label { font-size: var(--text-sm); color: var(--gray-500); }
    .hours-today-value { font-size: var(--text-xl); font-weight: 700; color: var(--primary-600); }
    
    .clock-btn-container {
      display: flex;
      justify-content: center;
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--gray-100);
    }
    
    .clock-btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      border: none;
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
    }
    
    .clock-btn:active { transform: scale(0.95); }
    .clock-btn.clock-in { background: var(--success-100); color: var(--success-700); }
    .clock-btn.clock-in:hover { background: var(--success-200); }
    .clock-btn.clock-out { background: var(--danger-100); color: var(--danger-700); }
    .clock-btn.clock-out:hover { background: var(--danger-200); }
    .clock-btn-icon { font-size: var(--text-base); }
    
    .current-job-card {
      background: linear-gradient(135deg, var(--warning-50) 0%, var(--warning-100) 100%);
      border: 2px solid var(--warning-300);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      transition: all 0.3s ease;
    }
    
    .current-job-card.sticky {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      z-index: 98;
      border-radius: 0;
      margin-bottom: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border-top: none;
      border-left: none;
      border-right: none;
    }
    
    .current-job-card-placeholder { display: none; }
    .current-job-card-placeholder.visible { display: block; margin-bottom: var(--space-4); }
    
    .current-job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-2); }
    .current-job-label { font-size: var(--text-sm); color: var(--warning-700); font-weight: 600; text-transform: uppercase; }
    .current-job-timer { font-size: var(--text-2xl); font-weight: 700; color: var(--warning-700); font-family: 'Outfit', monospace; }
    .current-job-client { font-size: var(--text-lg); font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-1); }
    .current-job-address { color: var(--gray-600); font-size: var(--text-sm); margin-bottom: var(--space-3); }
    .current-job-actions { display: flex; gap: var(--space-2); }
    
    .job-action-btn {
      flex: 1;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-lg);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      font-size: var(--text-sm);
    }
    
    .job-action-btn.complete { background: var(--success-500); color: white; }
    .job-action-btn.pause { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
    .job-action-btn.cancel { background: var(--danger-100); color: var(--danger-700); border: 1px solid var(--danger-300); }
    .job-action-btn.cancel:hover { background: var(--danger-200); }
    
    .schedule-card {
      background: white;
      border-radius: var(--radius-2xl);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      margin-bottom: var(--space-4);
    }
    
    .schedule-header {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .schedule-title { font-weight: 700; font-size: var(--text-lg); }
    .schedule-count { background: var(--primary-100); color: var(--primary-700); padding: var(--space-1) var(--space-3); border-radius: var(--radius-full); font-size: var(--text-sm); font-weight: 600; }
    
    .schedule-item {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    
    .schedule-item:hover:not(.completed):not(.active):not(.cancelled) { background: var(--gray-50); }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-item.completed { opacity: 0.5; background: var(--gray-50); cursor: not-allowed; }
    .schedule-item.active { background: var(--warning-50); border-left: 4px solid var(--warning-500); }
    .schedule-item.cancelled { opacity: 0.4; text-decoration: line-through; cursor: not-allowed; }
    
    .schedule-time { text-align: center; min-width: 50px; }
    .schedule-info { flex: 1; }
    .schedule-client { font-weight: 600; margin-bottom: 2px; }
    .schedule-address { font-size: var(--text-sm); color: var(--gray-500); }
    .schedule-door-code { font-size: var(--text-xs); color: var(--primary-600); margin-top: 2px; }
    .schedule-status { display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-1); }
    .schedule-price { font-weight: 700; color: var(--primary-600); }
    
    .schedule-order {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary-100);
      color: var(--primary-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-sm);
      flex-shrink: 0;
    }
    
    .schedule-item.completed .schedule-order { background: var(--success-100); color: var(--success-700); }
    .schedule-item.active .schedule-order { background: var(--warning-500); color: white; }
    .schedule-item.cancelled .schedule-order { background: var(--gray-200); color: var(--gray-500); }
    
    .empty-schedule { text-align: center; padding: var(--space-8); color: var(--gray-500); }
    .empty-schedule-icon { font-size: 3rem; margin-bottom: var(--space-3); }
    
    .admin-controls {
      background: white;
      border-radius: var(--radius-2xl);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-lg);
    }
    
    .admin-controls-title { font-weight: 700; font-size: var(--text-lg); margin-bottom: var(--space-4); color: var(--primary-700); }
    
    .admin-only { display: none; }
    .is-admin .admin-only { display: block; }
    
    .location-prompt {
      background: white;
      border-radius: var(--radius-2xl);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-xl);
      text-align: center;
      border: 2px solid var(--primary-200);
    }
    
    .location-prompt-icon { font-size: 2.5rem; margin-bottom: var(--space-2); }
    .location-prompt-title { font-size: var(--text-lg); font-weight: 700; margin-bottom: var(--space-2); }
    .location-prompt-text { color: var(--gray-600); margin-bottom: var(--space-3); font-size: var(--text-sm); }
    .location-prompt-client { background: var(--primary-50); border-radius: var(--radius-lg); padding: var(--space-3); margin-bottom: var(--space-3); }
    .location-prompt-client-name { font-weight: 700; }
    .location-prompt-client-address { color: var(--gray-600); font-size: var(--text-sm); }
    .location-prompt-actions { display: flex; gap: var(--space-2); }
    .location-prompt-actions .btn { flex: 1; }
    
    .employee-selection-container { display: flex; flex-direction: column; gap: var(--space-2); }
    
    .employee-selection-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .employee-selection-item:hover:not(.disabled) { background: var(--gray-100); }
    .employee-selection-item.selected { background: var(--primary-50); border-color: var(--primary-300); }
    .employee-selection-item.disabled { opacity: 0.8; cursor: not-allowed; background: linear-gradient(135deg, var(--primary-50), var(--primary-100)); border-color: var(--primary-400); }
    
    .employee-selection-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: var(--text-sm); flex-shrink: 0; }
    .employee-selection-info { flex: 1; }
    .employee-selection-name { font-weight: 600; color: var(--gray-900); }
    .employee-selection-role { font-size: var(--text-xs); color: var(--gray-500); }
    .employee-selection-checkbox { width: 24px; height: 24px; border-radius: var(--radius-md); border: 2px solid var(--gray-300); display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); flex-shrink: 0; }
    .employee-selection-item.selected .employee-selection-checkbox,
    .employee-selection-item.disabled .employee-selection-checkbox { background: var(--primary-500); border-color: var(--primary-500); color: white; }
    
    .job-details-preview { background: var(--gray-50); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-4); }
    .job-preview-client { font-size: var(--text-xl); font-weight: 700; margin-bottom: var(--space-1); }
    .job-preview-address { color: var(--gray-600); margin-bottom: var(--space-2); }
    .job-preview-door-code { color: var(--primary-600); font-weight: 600; margin-bottom: var(--space-3); }
    .job-preview-details { display: flex; gap: var(--space-4); flex-wrap: wrap; }
    .job-preview-detail { display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); }
    .job-preview-addons { margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--gray-200); }
    .job-preview-addon { display: inline-block; background: var(--warning-100); color: var(--warning-700); padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--text-xs); margin-right: var(--space-2); margin-bottom: var(--space-1); }
    
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--gray-100); }
    .history-item:last-child { border-bottom: none; }
    .history-info { display: flex; align-items: center; gap: var(--space-3); }
    .history-icon { width: 36px; height: 36px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: var(--text-lg); }
    .history-icon.clock-in { background: var(--success-100); }
    .history-icon.clock-out { background: var(--danger-100); }
    .history-icon.job { background: var(--primary-100); }
    .history-text { font-weight: 500; }
    .history-time { font-size: var(--text-sm); color: var(--gray-500); }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--gray-200); display: flex; padding: var(--space-2) var(--space-4); padding-bottom: max(var(--space-2), env(safe-area-inset-bottom)); z-index: 100; }
    .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: var(--space-2); color: var(--gray-500); text-decoration: none; font-size: var(--text-xs); border-radius: var(--radius-lg); transition: all var(--transition-fast); }
    .bottom-nav-item.active { color: var(--primary-600); }
    .bottom-nav-item:hover { background: var(--gray-100); }
    .bottom-nav-icon { font-size: var(--text-xl); }
    
    .timeclock-content { padding-bottom: 100px; }
    
    .day-summary-list { max-height: 300px; overflow-y: auto; }
    .day-summary-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--gray-50); border-radius: var(--radius-lg); margin-bottom: var(--space-2); }
    .day-summary-item:last-child { margin-bottom: 0; }
    .day-summary-employee { display: flex; align-items: center; gap: var(--space-2); }
    .day-summary-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: var(--text-xs); }
    .day-summary-name { font-weight: 600; }
    .day-summary-hours { font-weight: 700; color: var(--primary-600); font-size: var(--text-lg); }
    .day-summary-total { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3) var(--space-4); background: var(--primary-50); border-radius: var(--radius-lg); margin-top: var(--space-3); font-weight: 700; }
    
    .current-job-timer.warning { color: var(--danger-600); animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    @media (min-width: 768px) {
      .timeclock-layout { display: flex; }
      .timeclock-main { flex: 1; max-width: 600px; margin: 0 auto; }
      .bottom-nav { display: none; }
      .timeclock-content { padding-bottom: var(--space-6); }
    }
  </style>
</head>
<body>
  <div class="timeclock-layout" id="mainLayout">
    <div class="timeclock-main">
      <!-- REDESIGNED: Sticky Header with Date/Time (removed logo, added date) -->
      <header class="timeclock-header">
        <div class="header-left">
          <div class="header-date-time">
            <div class="header-date" id="currentDate">S√°bado, 13 de diciembre</div>
            <div class="header-time">
              <span id="currentTime">09:45</span><span id="currentSeconds" style="font-size: var(--text-sm); opacity: 0.7;">:32</span>
            </div>
          </div>
        </div>
        <div class="timeclock-header-actions">
          <!-- NEW: Refresh button -->
          <button class="timeclock-header-btn" id="refreshBtn" title="Refresh">üîÑ</button>
          <button class="timeclock-header-btn" id="langToggle" title="Language">üåê</button>
          <!-- REMOVED: navNextBtn and historyBtn as requested -->
          <button class="timeclock-header-btn" id="logoutBtn" title="Logout">üö™</button>
        </div>
      </header>

      <!-- NEW: Team Selector Dropdown (sticky below header) -->
      <div class="team-selector" id="teamSelector">
        <button class="team-selector-btn" id="teamSelectorBtn">
          <span id="teamBanner">üë• Equipo: --</span>
          <span class="team-selector-arrow">‚ñº</span>
        </button>
        <div class="team-members-dropdown" id="teamMembersDropdown">
          <!-- Team members will be rendered here -->
        </div>
      </div>

      <div class="timeclock-content">
        <!-- NEW: Admin Info Banner (only shown for admins) -->
        <div class="admin-info-banner admin-only" id="adminInfoBanner">
          üëë Modo Administrador - Las horas no se registran
        </div>

        <!-- NEW: Admin Quick Actions Navigation (only shown for admins) -->
        <div class="admin-quick-actions admin-only" id="adminQuickActions">
          <a href="dashboard.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üìä</span>
            <span class="admin-quick-btn-text">Dashboard</span>
          </a>
          <a href="scheduling.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üìÖ</span>
            <span class="admin-quick-btn-text">Horarios</span>
          </a>
          <a href="clients.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üè†</span>
            <span class="admin-quick-btn-text">Clientes</span>
          </a>
          <a href="employees.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üë•</span>
            <span class="admin-quick-btn-text">Empleados</span>
          </a>
          <a href="finances.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üí∞</span>
            <span class="admin-quick-btn-text">Finanzas</span>
          </a>
          <a href="reports.html" class="admin-quick-btn">
            <span class="admin-quick-btn-icon">üìà</span>
            <span class="admin-quick-btn-text">Reportes</span>
          </a>
        </div>

        <!-- Status Card (clock in/out hidden for admins) -->
        <div class="status-card" id="statusCard">
          <div class="status-header">
            <div class="status-indicator">
              <div class="status-dot clocked-out" id="statusDot"></div>
              <span class="status-text clocked-out" id="statusText">Sin Registrar</span>
            </div>
            <div class="hours-today" id="hoursTodaySection">
              <div class="hours-today-label" data-i18n="hoursToday">Horas Hoy</div>
              <div class="hours-today-value" id="hoursToday">0:00</div>
            </div>
          </div>
          <div class="clock-btn-container" id="clockBtnContainer">
            <button class="clock-btn clock-in" id="clockBtn">
              <span class="clock-btn-icon">‚ñ∂Ô∏è</span>
              <span data-i18n="clockIn">Registrar Entrada</span>
            </button>
          </div>
        </div>

        <div class="current-job-card-placeholder" id="currentJobCardPlaceholder"></div>
        
        <div class="current-job-card hidden" id="currentJobCard">
          <div class="current-job-header">
            <div class="current-job-label">üè† <span data-i18n="currentlyWorking">Trabajando</span></div>
            <div class="current-job-timer" id="jobTimer">0:00:00</div>
          </div>
          <div class="current-job-client" id="currentJobClient">-</div>
          <div class="current-job-address" id="currentJobAddress">-</div>
          <div class="current-job-actions">
            <button class="job-action-btn" id="navigateJobBtn">üß≠ Navegar</button>
            <button class="job-action-btn cancel" id="cancelJobBtn">‚ùå Cancelar</button>
            <button class="job-action-btn complete" id="completeJobBtn">‚úî Completar</button>
          </div>
        </div>

        <div class="location-prompt hidden" id="locationPrompt">
          <div class="location-prompt-icon">üìç</div>
          <div class="location-prompt-title">Cliente Cercano Detectado</div>
          <div class="location-prompt-text">¬øDesea iniciar el trabajo aqu√≠?</div>
          <div class="location-prompt-client">
            <div class="location-prompt-client-name" id="locationClientName">-</div>
            <div class="location-prompt-client-address" id="locationClientAddress">-</div>
          </div>
          <div class="location-prompt-actions">
            <button class="btn btn-secondary" id="locationDismissBtn">Ahora No</button>
            <button class="btn btn-success" id="locationStartBtn">‚ñ∂Ô∏è Iniciar</button>
          </div>
        </div>

        <!-- Admin Team Filter -->
        <div class="admin-controls admin-only" id="adminControls">
          <div class="admin-controls-title">üîß Controles de Admin</div>
          <div class="form-group">
            <label class="form-label">Ver Equipo</label>
            <select class="form-select" id="adminTeamFilter">
              <option value="">Todos los Equipos</option>
            </select>
          </div>
        </div>

        <div class="schedule-card">
          <div class="schedule-header">
            <div class="schedule-title" data-i18n="todaySchedule">Horario de Hoy</div>
            <div class="schedule-count" id="scheduleCount">0 trabajos</div>
          </div>
          <div class="schedule-list" id="scheduleList">
            <div class="empty-schedule" id="emptySchedule">
              <div class="empty-schedule-icon">üìÖ</div>
              <div>No hay trabajos programados para hoy</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav" id="bottomNav">
      <a href="timeclock.html" class="bottom-nav-item active">
        <span class="bottom-nav-icon">‚è±Ô∏è</span>
        <span>Reloj</span>
      </a>
      <a href="scheduling.html" class="bottom-nav-item admin-only">
        <span class="bottom-nav-icon">üìÖ</span>
        <span>Horario</span>
      </a>
      <a href="dashboard.html" class="bottom-nav-item admin-only">
        <span class="bottom-nav-icon">üìä</span>
        <span>Panel</span>
      </a>
    </nav>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"></div>

  <!-- All modals remain the same, just adding admin extras section -->
  <div class="modal" id="startJobModal">
    <div class="modal-header">
      <h3 class="modal-title">Iniciar Trabajo</h3>
      <button class="modal-close" id="closeStartJobModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="job-details-preview" id="jobPreview">
        <div class="job-preview-client" id="previewClient">-</div>
        <div class="job-preview-address" id="previewAddress">-</div>
        <div class="job-preview-door-code hidden" id="previewDoorCode">üîë C√≥digo: </div>
        <div class="job-preview-details">
          <div class="job-preview-detail"><span>‚è±Ô∏è</span><span id="previewDuration">2 horas</span></div>
          <div class="job-preview-detail"><span>üí∞</span><span id="previewPrice">$150</span></div>
        </div>
        <div class="job-preview-addons hidden" id="previewAddons">
          <strong>Extras:</strong>
          <div id="previewAddonsList"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirmar Empleados</label>
        <div class="employee-selection-container" id="jobTeamMembers"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Notas</label>
        <textarea class="form-input" id="startJobNotes" rows="2" placeholder="Notas antes de iniciar..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelStartJobBtn">Cancelar</button>
      <button type="button" class="btn btn-success" id="confirmStartJobBtn">‚ñ∂Ô∏è Iniciar</button>
    </div>
  </div>

  <div class="modal" id="completeJobModal">
    <div class="modal-header">
      <h3 class="modal-title">Completar Trabajo</h3>
      <button class="modal-close" id="closeCompleteJobModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="card mb-4" style="background: var(--success-50); border-color: var(--success-200);">
        <div class="card-body text-center">
          <div class="text-4xl mb-2">‚úî</div>
          <div class="font-semibold" id="completeJobClient">-</div>
          <div class="text-gray-500" id="completeJobAddress">-</div>
          <div class="mt-3">
            <span class="text-3xl font-bold text-success" id="completeJobTime">0:00:00</span>
          </div>
        </div>
      </div>
      <div class="form-group" id="completedAddonsGroup" style="display: none;">
        <label class="form-label">Extras Completados</label>
        <div id="completedAddonsList"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Pago Recibido</label>
        <select class="form-select" id="paymentMethod">
          <option value="">No se recibi√≥ pago</option>
          <option value="cash">Efectivo</option>
          <option value="check">Cheque</option>
          <option value="card">Tarjeta</option>
          <option value="venmo">Venmo</option>
          <option value="zelle">Zelle</option>
        </select>
      </div>
      <div class="form-group hidden" id="paymentAmountGroup">
        <label class="form-label">Monto</label>
        <div class="input-group">
          <span class="input-group-prepend">$</span>
          <input type="number" class="form-input" id="paymentAmount" step="0.01" min="0">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notas</label>
        <textarea class="form-input" id="completeJobNotes" rows="2" placeholder="Problemas o notas..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelCompleteJobBtn">Cancelar</button>
      <button type="button" class="btn btn-success" id="confirmCompleteJobBtn">‚úî Completar</button>
    </div>
  </div>

  <div class="modal modal-lg" id="historyModal">
    <div class="modal-header">
      <h3 class="modal-title">Actividad de Hoy</h3>
      <button class="modal-close" id="closeHistoryModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="historyList"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="closeHistoryBtn">Cerrar</button>
    </div>
  </div>

  <!-- Admin Status Modal with extras management -->
  <div class="modal" id="adminStatusModal">
    <div class="modal-header">
      <h3 class="modal-title">Cambiar Estado (Admin)</h3>
      <button class="modal-close" id="closeAdminStatusModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="job-details-preview">
        <div class="job-preview-client" id="adminStatusClient">-</div>
        <div class="job-preview-address" id="adminStatusAddress">-</div>
      </div>
      <div class="form-group">
        <label class="form-label">Nuevo Estado</label>
        <select class="form-select" id="adminNewStatus">
          <option value="scheduled">Programado</option>
          <option value="in_progress">En Progreso</option>
          <option value="completed">Completado</option>
          <option value="cancelled">Cancelado</option>
          <option value="rescheduled">Reprogramado</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notas</label>
        <textarea class="form-input" id="adminStatusNotes" rows="2" placeholder="Raz√≥n del cambio..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelAdminStatusBtn">Cancelar</button>
      <button type="button" class="btn btn-primary" id="confirmAdminStatusBtn">Actualizar</button>
    </div>
  </div>

  <div class="modal" id="cancelJobModal">
    <div class="modal-header">
      <h3 class="modal-title">Cancelar Trabajo</h3>
      <button class="modal-close" id="closeCancelJobModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="card mb-4" style="background: var(--danger-50); border-color: var(--danger-200);">
        <div class="card-body text-center">
          <div class="text-4xl mb-2">‚ùå</div>
          <div class="font-semibold" id="cancelJobClient">-</div>
          <div class="text-gray-500" id="cancelJobAddress">-</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Raz√≥n de Cancelaci√≥n</label>
        <select class="form-select" id="cancelReason">
          <option value="client_cancelled">Cliente cancel√≥ en llegada</option>
          <option value="no_answer">No contestaron</option>
          <option value="wrong_address">Direcci√≥n incorrecta</option>
          <option value="reschedule">Reprogramar</option>
          <option value="other">Otra raz√≥n</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notas</label>
        <textarea class="form-input" id="cancelJobNotes" rows="2" placeholder="Detalles adicionales..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelCancelJobBtn">Volver</button>
      <button type="button" class="btn btn-danger" id="confirmCancelJobBtn">‚ùå Confirmar Cancelaci√≥n</button>
    </div>
  </div>

  <div class="modal" id="daySummaryModal">
    <div class="modal-header">
      <h3 class="modal-title">üìä Resumen del D√≠a</h3>
      <button class="modal-close" id="closeDaySummaryModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="day-summary-list" id="daySummaryList"></div>
      <div class="day-summary-total">
        <span>Total del Equipo</span>
        <span id="daySummaryTotal">0:00</span>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" id="closeDaySummaryBtn">¬°Buen Trabajo! üéâ</button>
    </div>
  </div>

  <div class="location-prompt hidden" id="routePrompt" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1100; max-width: 350px; width: 90%;">
    <div class="location-prompt-icon">üó∫Ô∏è</div>
    <div class="location-prompt-title" id="routePromptTitle">Siguiente Destino</div>
    <div class="location-prompt-text" id="routePromptText">¬øDesea direcciones?</div>
    <div class="location-prompt-client">
      <div class="location-prompt-client-name" id="routeClientName">-</div>
      <div class="location-prompt-client-address" id="routeClientAddress">-</div>
    </div>
    <div class="location-prompt-actions">
      <button class="btn btn-secondary" id="routeDismissBtn">Ahora No</button>
      <button class="btn btn-primary" id="routeDirectionsBtn">üß≠ Ver Direcciones</button>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

<script type="module">
    import { 
      auth, db, onAuthStateChanged, signOut,
      collection, doc, getDoc, getDocs, addDoc, updateDoc, 
      query, where, orderBy, Timestamp
    } from './js/firebase-config.js';
    import { i18n } from './js/i18n.js';
    import { 
      showToast, openModal, closeModal, closeAllModals,
      formatCurrency, getInitials
    } from './js/utils.js';
    import { logScheduleAction, AuditActions } from './js/audit.js';

    // Force Spanish as default
    (function() {
      if (!sessionStorage.getItem('timeclock_lang_set')) {
        i18n.setLanguage('es');
        sessionStorage.setItem('timeclock_lang_set', 'true');
      }
    })();

    // State variables
    let currentUser = null;
    let currentAdmin = null;
    let currentEmployee = null;
    let currentTeam = null;
    let allTeams = [];
    let teamMembers = [];
    let todaySchedules = [];
    let clients = {};
    let isAdmin = false;
    let isSuperAdmin = false;
    let isTeamLeader = false;
    let officeSettings = null;
    
    let isClockedIn = false;
    let clockInTime = null;
    let currentJob = null;
    let jobStartTime = null;
    let timeEntries = [];
    let selectedJobEmployees = [];
    
    let clockInterval = null;
    let jobTimerInterval = null;
    let timeCheckInterval = null;
    let adminSelectedScheduleId = null;
    let selectedScheduleId = null;
    let nearbySchedule = null;
    let lastLongTimePrompt = 0;
    let lastOfficePrompt = 0;

    // IndexedDB for persistent state
    const DB_NAME = 'CleanProTimeclock';
    const DB_VERSION = 1;
    const STORE_NAME = 'state';
    let idb = null;

    async function initDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => { idb = req.result; resolve(idb); };
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    async function saveStateToDB(state) {
      if (!idb) return;
      return new Promise((resolve, reject) => {
        const tx = idb.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).put({ id: 'current', ...state, savedAt: Date.now() });
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    async function loadStateFromDB() {
      if (!idb) return null;
      return new Promise((resolve, reject) => {
        const tx = idb.transaction([STORE_NAME], 'readonly');
        const req = tx.objectStore(STORE_NAME).get('current');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function clearDBState() {
      if (!idb) return;
      return new Promise((resolve) => {
        const tx = idb.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete('current');
        tx.oncomplete = () => resolve();
      });
    }

    // ============================================
    // HELPERS
    // ============================================
    function getLocalDateString(date = new Date()) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getAvatarColor(name) {
      const colors = ['#0d9488', '#f97316', '#8b5cf6', '#ec4899', '#10b981', '#3b82f6', '#f59e0b', '#ef4444'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      return colors[Math.abs(hash) % colors.length];
    }

    function formatTime(date) {
      return date.toLocaleTimeString('es-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    function msToHoursMinutes(ms) {
      const totalMinutes = Math.floor(ms / 60000);
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${hours}:${String(minutes).padStart(2, '0')}`;
    }
    
    function formatHoursMinutes(decimalHours) {
      const hours = Math.floor(decimalHours);
      const minutes = Math.round((decimalHours - hours) * 60);
      return `${hours}:${String(minutes).padStart(2, '0')}`;
    }
    
    // Check if user should track hours (false for admins)
    function shouldTrackHours() {
      return !(isAdmin || isSuperAdmin);
    }

    // ============================================
    // AUTH & INIT
    // ============================================
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        try {
          await initDB();
          
          const adminDoc = await getDoc(doc(db, 'admins', user.uid));
          if (adminDoc.exists()) {
            currentAdmin = { id: adminDoc.id, ...adminDoc.data() };
            isAdmin = currentAdmin.role === 'admin' || currentAdmin.role === 'manager';
            isSuperAdmin = currentAdmin.role === 'super_admin';
            if (isAdmin || isSuperAdmin) document.body.classList.add('is-admin');
            await initializePage();
          } else {
            const empQuery = query(collection(db, 'employees'), where('email', '==', user.email));
            const empSnap = await getDocs(empQuery);
            if (!empSnap.empty) {
              currentEmployee = { id: empSnap.docs[0].id, ...empSnap.docs[0].data() };
              isTeamLeader = currentEmployee.role === 'team_leader';
              if (!isTeamLeader && !isAdmin) {
                const bottomNav = document.getElementById('bottomNav');
                if (bottomNav) bottomNav.classList.add('hidden');
              }
              await initializePage();
            } else {
              showToast('error', 'Error', 'Cuenta no configurada. Contacte al administrador.');
              await signOut(auth);
              window.location.href = 'index.html';
            }
          }
        } catch (error) {
          console.error('Auth error:', error);
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    async function initializePage() {
      updateClock();
      clockInterval = setInterval(updateClock, 1000);
      
      await loadOfficeSettings();
      await loadClients();
      await loadAllTeams();
      await loadTeamInfo();
      await loadTodaySchedules();
      await loadTimeEntries();
      
      await restoreState();
      updateStatusUI();
      renderSchedule();
      renderTeamMembersDropdown();
      
      try {
        setupEventListeners();
      } catch (e) {
        console.error('Event listener setup error:', e);
      }
      setupStickyJobCard();
      
      // Start time monitoring only for non-admins
      if (shouldTrackHours()) {
        startTimeMonitoring();
      }
      
      // Update team banner
      if (currentTeam) {
        document.getElementById('teamBanner').textContent = 'üë• ' + currentTeam.name;
      } else if (isAdmin || isSuperAdmin) {
        document.getElementById('teamBanner').textContent = 'üëë Admin - Todos los Equipos';
      }
      
      if (isAdmin || isSuperAdmin) {
        populateAdminTeamFilter();
        // Hide clock button and hours for admins
        const clockBtnContainer = document.getElementById('clockBtnContainer');
        const hoursTodaySection = document.getElementById('hoursTodaySection');
        if (clockBtnContainer) clockBtnContainer.style.display = 'none';
        if (hoursTodaySection) hoursTodaySection.style.display = 'none';
      }
      
      initPWA();
      initGeolocation();
      checkOfficeArrival();
    }

    // ============================================
    // TEAM DROPDOWN
    // ============================================
    function renderTeamMembersDropdown() {
      const container = document.getElementById('teamMembersDropdown');
      if (!container) return;
      
      if (teamMembers.length === 0) {
        container.innerHTML = '<div class="team-member-item"><span style="color: white; opacity: 0.7;">Sin miembros de equipo</span></div>';
        return;
      }
      
      container.innerHTML = teamMembers.map(m => {
        const isLeader = currentTeam?.leaderId === m.id;
        const avatarColor = getAvatarColor(m.firstName + m.lastName);
        const initials = getInitials(m.firstName, m.lastName);
        
        return `
          <div class="team-member-item">
            <div class="team-member-avatar-sm" style="background-color:${avatarColor}">${initials}</div>
            <div class="team-member-info-sm">
              <div class="team-member-name-sm">${m.firstName} ${m.lastName}</div>
              <div class="team-member-role-sm">${isLeader ? '‚≠ê L√≠der' : 'Miembro'}</div>
            </div>
            <div class="team-member-status-sm ${m.isActive ? 'active' : ''}"></div>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // REFRESH DATA
    // ============================================
    async function refreshData() {
      await loadTodaySchedules();
      await loadTimeEntries();
      await restoreState();
      renderSchedule();
      renderTeamMembersDropdown();
      updateStatusUI();
      if (currentJob && jobStartTime) updateJobTimer();
      initGeolocation();
    }

    // ============================================
    // OFFICE SETTINGS & TIME MONITORING
    // ============================================
    async function loadOfficeSettings() {
      try {
        const configDoc = await getDoc(doc(db, 'config', 'officeSettings'));
        if (configDoc.exists()) officeSettings = configDoc.data();
      } catch (e) { 
        console.warn('Could not load office settings:', e); 
      }
    }
    
    function startTimeMonitoring() {
      if (!shouldTrackHours()) return;
      timeCheckInterval = setInterval(checkTimeConditions, 60000);
    }
    
    function checkTimeConditions() {
      if (!shouldTrackHours()) return;
      
      const now = Date.now();
      
      // Check if clocked in for too long (>10 hours)
      if (isClockedIn && clockInTime) {
        const clockedInMs = now - clockInTime.getTime();
        const clockedInHours = clockedInMs / 3600000;
        
        if (clockedInHours > 10 && (now - lastLongTimePrompt > 3600000)) {
          lastLongTimePrompt = now;
          if (confirm(`Llevas ${Math.floor(clockedInHours)} horas registrado. ¬øDeseas registrar salida?`)) {
            clockOut();
          }
        }
      }
      
      // Check if current job is taking too long (>5 hours)
      if (currentJob && jobStartTime) {
        const jobMs = now - jobStartTime.getTime();
        const jobHours = jobMs / 3600000;
        
        if (jobHours > 5) {
          const timerEl = document.getElementById('jobTimer');
          if (timerEl) timerEl.classList.add('warning');
          
          if (now - lastLongTimePrompt > 3600000) {
            lastLongTimePrompt = now;
            showToast('warning', 'Aviso', `El trabajo actual lleva m√°s de ${Math.floor(jobHours)} horas. ¬øTodo bien?`);
          }
        }
      }
      
      checkIfAllJobsDone();
    }
    
    function checkIfAllJobsDone() {
      if (!shouldTrackHours()) return;
      if (!isClockedIn || currentJob) return;
      
      const pendingJobs = todaySchedules.filter(s => s.status === 'scheduled' || s.status === 'in_progress');
      if (pendingJobs.length > 0) return;
      
      if (!officeSettings?.start?.coordinates) return;
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const dist = haversine(pos.coords.latitude, pos.coords.longitude,
            officeSettings.start.coordinates.lat, officeSettings.start.coordinates.lng);
          
          if (dist < 0.15) {
            const now = Date.now();
            if (now - lastOfficePrompt > 300000) {
              lastOfficePrompt = now;
              if (confirm('¬°Todos los trabajos completados! Est√°s en la oficina. ¬øDeseas registrar salida?')) {
                clockOut();
              }
            }
          }
        },
        () => {},
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    
    function checkOfficeArrival() {
      if (!officeSettings?.start?.coordinates) return;
      if (isClockedIn || currentJob) return;
      
      const now = new Date();
      const hour = now.getHours();
      if (hour < 6 || hour > 12) return;
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const dist = haversine(pos.coords.latitude, pos.coords.longitude, 
            officeSettings.start.coordinates.lat, officeSettings.start.coordinates.lng);
          
          if (dist < 0.15) {
            const sortedSchedules = sortSchedulesByRoute(todaySchedules);
            const firstScheduled = sortedSchedules.find(s => s.status === 'scheduled');
            if (firstScheduled) {
              const client = clients[firstScheduled.clientId];
              if (client) showRoutePrompt(client, 'first');
            }
          }
        },
        (err) => console.log('Office check error:', err.message),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    
    function showRoutePrompt(client, type) {
      const now = Date.now();
      if (now - lastOfficePrompt < 300000) return;
      lastOfficePrompt = now;
      
      if (type === 'first') {
        document.getElementById('routePromptTitle').textContent = 'üó∫Ô∏è Iniciar Ruta';
        document.getElementById('routePromptText').textContent = '¬øDesea direcciones al primer cliente?';
      } else if (type === 'office') {
        document.getElementById('routePromptTitle').textContent = 'üè¢ Regresar a Oficina';
        document.getElementById('routePromptText').textContent = '¬øDesea direcciones a la oficina?';
      }
      
      document.getElementById('routeClientName').textContent = type === 'office' ? 'Oficina' : `${client.firstName} ${client.lastName}`;
      document.getElementById('routeClientAddress').textContent = type === 'office' 
        ? (officeSettings?.start?.street || '') 
        : (client.address?.street || '');
      
      const routePrompt = document.getElementById('routePrompt');
      routePrompt.dataset.type = type;
      routePrompt.dataset.clientId = client?.id || '';
      routePrompt.classList.remove('hidden');
    }
    
    function openDirections(address) {
      if (!address) return;
      const encodedAddress = encodeURIComponent(address);
      const ua = navigator.userAgent || '';
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);
      
      try {
        if (isIOS) {
          window.open(`maps://?daddr=${encodedAddress}`, '_blank');
          return;
        }
        if (isAndroid) {
          window.open(`https://maps.google.com/maps?daddr=${encodedAddress}`, '_blank');
          return;
        }
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
      } catch (e) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
      }
    }

    function getAddressFromClient(client) {
      if (!client || !client.address) return '';
      const a = client.address;
      if (a.coordinates && a.coordinates.lat && a.coordinates.lng) {
        return `${a.coordinates.lat},${a.coordinates.lng}`;
      }
      return [a.street, a.city, a.state, a.zip].filter(Boolean).join(', ');
    }

    function navigateToNextClient() {
      const sorted = sortSchedulesByRoute(todaySchedules);
      if (!sorted || sorted.length === 0) {
        showToast('info', 'Sin trabajos', 'No hay m√°s trabajos programados');
        return;
      }

      let candidate = null;
      if (currentJob) {
        const idx = sorted.findIndex(s => s.id === currentJob.scheduleId);
        if (idx >= 0) {
          candidate = sorted.slice(idx + 1).find(s => s.status === 'scheduled' || s.status === 'in_progress');
        }
      }

      if (!candidate) candidate = sorted.find(s => s.status === 'scheduled' || s.status === 'in_progress');

      if (!candidate) {
        showToast('info', 'Sin destino', 'No se encontr√≥ el siguiente trabajo');
        return;
      }

      const client = clients[candidate.clientId];
      const address = getAddressFromClient(client);
      if (!address) {
        showToast('error', 'Sin direcci√≥n', 'El cliente no tiene direcci√≥n');
        return;
      }
      openDirections(address);
    }

    // ============================================
    // PWA
    // ============================================
    function initPWA() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      }
      
      document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible') {
          console.log('App became visible - refreshing data...');
          await refreshData();
        }
      });
      
      window.addEventListener('focus', async () => {
        console.log('App focused - refreshing data...');
        await refreshData();
      });
      
      setInterval(async () => {
        if (document.visibilityState === 'visible') {
          await loadTodaySchedules();
          renderSchedule();
        }
      }, 120000);
    }

    // ============================================
    // GEOLOCATION
    // ============================================
    function initGeolocation() {
      if (isClockedIn && currentJob) return;
      if (!('geolocation' in navigator)) {
        console.log('Geolocation not supported');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          console.log('Got location:', pos.coords.latitude, pos.coords.longitude);
          checkNearbyClients(pos.coords.latitude, pos.coords.longitude);
        },
        (err) => {
          console.log('Geolocation error:', err.message);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
      );
    }

    function checkNearbyClients(userLat, userLng) {
      if (isClockedIn || currentJob) return;
      
      console.log('Checking nearby clients from', todaySchedules.length, 'schedules');
      
      for (const schedule of todaySchedules) {
        if (schedule.status !== 'scheduled') continue;
        
        const client = clients[schedule.clientId];
        if (!client?.address?.coordinates) continue;
        
        const dist = haversine(userLat, userLng, client.address.coordinates.lat, client.address.coordinates.lng);
        console.log(`Distance to ${client.firstName}: ${dist.toFixed(2)} km`);
        if (dist < 0.15) {
          showLocationPrompt(schedule, client);
          return;
        }
      }
      
      console.log('No nearby clients found');
    }
    
    function showLocationPrompt(schedule, client) {
      nearbySchedule = schedule;
      document.getElementById('locationClientName').textContent = `${client.firstName} ${client.lastName}`;
      document.getElementById('locationClientAddress').textContent = client.address?.street || '';
      document.getElementById('locationPrompt').classList.remove('hidden');
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ============================================
    // STICKY JOB CARD
    // ============================================
    function setupStickyJobCard() {
      const card = document.getElementById('currentJobCard');
      const placeholder = document.getElementById('currentJobCardPlaceholder');
      let cardTop = 0;

      function update() {
        if (card.classList.contains('hidden')) {
          card.classList.remove('sticky');
          placeholder.classList.remove('visible');
          return;
        }
        
        if (!card.classList.contains('sticky')) {
          cardTop = card.getBoundingClientRect().top + window.scrollY;
        }
        
        if (window.scrollY > cardTop - 60) {
          if (!card.classList.contains('sticky')) {
            placeholder.style.height = card.offsetHeight + 'px';
            card.classList.add('sticky');
            placeholder.classList.add('visible');
          }
        } else {
          card.classList.remove('sticky');
          placeholder.classList.remove('visible');
        }
      }
      
      window.addEventListener('scroll', update, { passive: true });
      window.addEventListener('resize', update);
    }

    // ============================================
    // DATA LOADING
    // ============================================
    async function loadClients() {
      try {
        const snap = await getDocs(collection(db, 'clients'));
        snap.forEach(d => { clients[d.id] = { id: d.id, ...d.data() }; });
      } catch (e) { 
        console.error('Load clients error:', e); 
      }
    }

    async function loadAllTeams() {
      try {
        const snap = await getDocs(collection(db, 'teams'));
        allTeams = [];
        snap.forEach(d => allTeams.push({ id: d.id, ...d.data() }));
      } catch (e) { 
        console.error('Load teams error:', e); 
      }
    }

    async function loadTodaySchedules() {
      try {
        const todayStr = getLocalDateString();
        let q;
        const filter = document.getElementById('adminTeamFilter')?.value;
        
        if ((isAdmin || isSuperAdmin) && !filter) {
          q = query(collection(db, 'schedules'), where('date', '==', todayStr), orderBy('timeSlot'));
        } else {
          const teamId = filter || currentTeam?.id;
          q = teamId 
            ? query(collection(db, 'schedules'), where('date', '==', todayStr), where('teamId', '==', teamId), orderBy('timeSlot'))
            : query(collection(db, 'schedules'), where('date', '==', todayStr), orderBy('timeSlot'));
        }
        
        const snap = await getDocs(q);
        todaySchedules = [];
        snap.forEach(d => todaySchedules.push({ id: d.id, ...d.data() }));
        document.getElementById('scheduleCount').textContent = `${todaySchedules.length} trabajos`;
      } catch (e) { 
        console.error('Load schedules error:', e); 
      }
    }

    async function loadTimeEntries() {
      try {
        const todayStr = getLocalDateString();
        const q = query(collection(db, 'timeEntries'), where('date', '==', todayStr));
        const snap = await getDocs(q);
        timeEntries = [];
        snap.forEach(d => timeEntries.push({ id: d.id, ...d.data() }));
      } catch (e) { 
        console.error('Load time entries error:', e); 
      }
    }

    async function loadTeamInfo() {
      try {
        if (currentEmployee?.teamId) {
          const teamDoc = await getDoc(doc(db, 'teams', currentEmployee.teamId));
          if (teamDoc.exists()) currentTeam = { id: teamDoc.id, ...teamDoc.data() };
        }
        
        if (currentTeam) {
          const snap = await getDocs(query(collection(db, 'employees'), where('teamId', '==', currentTeam.id)));
          teamMembers = [];
          snap.forEach(d => teamMembers.push({ id: d.id, ...d.data() }));
        }
      } catch (e) { 
        console.error('Load team error:', e); 
      }
    }

    function populateAdminTeamFilter() {
      const sel = document.getElementById('adminTeamFilter');
      if (!sel) return;
      sel.innerHTML = '<option value="">Todos</option>' + allTeams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    // ============================================
    // CLOCK & TIMER
    // ============================================
    function updateClock() {
      const now = new Date();
      // Shorter date format: "S√°bado, 13 de diciembre"
      const dateStr = now.toLocaleDateString('es-MX', {
        weekday: 'long', day: 'numeric', month: 'long'
      });
      document.getElementById('currentDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
      document.getElementById('currentTime').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      document.getElementById('currentSeconds').textContent = `:${String(now.getSeconds()).padStart(2,'0')}`;
      
      if (shouldTrackHours() && isClockedIn && clockInTime) updateHoursWorked();
    }

    function updateHoursWorked() {
      if (!shouldTrackHours()) return;
      
      const now = new Date();
      let totalMs = 0;
      timeEntries.forEach(e => {
        if (e.clockOut) {
          const cin = e.clockIn?.toDate ? e.clockIn.toDate() : new Date(e.clockIn);
          const cout = e.clockOut?.toDate ? e.clockOut.toDate() : new Date(e.clockOut);
          totalMs += cout - cin;
        }
      });
      if (isClockedIn && clockInTime) totalMs += now - clockInTime;
      const h = Math.floor(totalMs / 3600000);
      const m = Math.floor((totalMs % 3600000) / 60000);
      document.getElementById('hoursToday').textContent = `${h}:${String(m).padStart(2,'0')}`;
    }

    function updateJobTimer() {
      if (!jobStartTime) return;
      const elapsed = Date.now() - jobStartTime.getTime();
      const h = Math.floor(elapsed / 3600000);
      const m = Math.floor((elapsed % 3600000) / 60000);
      const s = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('jobTimer').textContent = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    // ============================================
    // CLOCK IN/OUT
    // ============================================
    async function clockIn() {
      // Admins don't track hours
      if (!shouldTrackHours()) {
        isClockedIn = true;
        clockInTime = new Date();
        await saveState();
        updateStatusUI();
        return;
      }
      
      clockInTime = new Date();
      isClockedIn = true;
      const sessionId = `session_${Date.now()}`;
      
      try {
        const todayStr = getLocalDateString();
        const currentUserId = currentAdmin?.id || currentEmployee?.id;
        
        const entry = {
          date: todayStr,
          employeeId: currentUserId,
          clockIn: Timestamp.fromDate(clockInTime),
          clockOut: null,
          hoursWorked: null,
          sessionId: sessionId,
          createdAt: Timestamp.now()
        };
        const ref = await addDoc(collection(db, 'timeEntries'), entry);
        timeEntries.push({ id: ref.id, ...entry, clockIn: clockInTime });
        
        localStorage.setItem('currentSessionId', sessionId);
        
        // Also create time entries for all team members
        for (const member of teamMembers) {
          if (member.id !== currentUserId) {
            const memberEntry = {
              date: todayStr,
              employeeId: member.id,
              clockIn: Timestamp.fromDate(clockInTime),
              clockOut: null,
              hoursWorked: null,
              sessionId: sessionId,
              teamClockIn: true,
              clockedInBy: currentUserId,
              createdAt: Timestamp.now()
            };
            const memberRef = await addDoc(collection(db, 'timeEntries'), memberEntry);
            timeEntries.push({ id: memberRef.id, ...memberEntry, clockIn: clockInTime });
          }
        }
        
        showToast('success', '√âxito', 'Entrada registrada para el equipo');
      } catch (e) {
        console.error('Clock in error:', e);
        showToast('error', 'Error', 'No se pudo registrar entrada');
      }
      
      await saveState();
      updateStatusUI();
    }

    async function clockOut() {
      if (currentJob) {
        showToast('warning', 'Aviso', 'Complete el trabajo actual antes de salir');
        return;
      }
      
      // Admins don't track hours
      if (!shouldTrackHours()) {
        isClockedIn = false;
        clockInTime = null;
        await saveState();
        updateStatusUI();
        return;
      }
      
      const clockOutTime = new Date();
      const currentSessionId = localStorage.getItem('currentSessionId');
      
      const openEntries = timeEntries.filter(e => 
        !e.clockOut && (currentSessionId ? e.sessionId === currentSessionId : true)
      );
      
      if (openEntries.length === 0) {
        showToast('warning', 'Aviso', 'No hay entradas abiertas para cerrar');
        isClockedIn = false;
        clockInTime = null;
        await saveState();
        updateStatusUI();
        return;
      }
      
      const employeeHours = {};
      
      try {
        for (const entry of openEntries) {
          const cin = entry.clockIn?.toDate ? entry.clockIn.toDate() : clockInTime;
          const hoursMs = clockOutTime - cin;
          const hours = hoursMs / 3600000;
          
          await updateDoc(doc(db, 'timeEntries', entry.id), {
            clockOut: Timestamp.fromDate(clockOutTime),
            hoursWorked: hours
          });
          entry.clockOut = clockOutTime;
          entry.hoursWorked = hours;
          
          if (!employeeHours[entry.employeeId]) employeeHours[entry.employeeId] = 0;
          employeeHours[entry.employeeId] += hoursMs;
        }
        
        localStorage.removeItem('currentSessionId');
        showToast('success', '√âxito', 'Salida registrada para el equipo');
        showDaySummary(employeeHours);
      } catch (e) {
        console.error('Clock out error:', e);
        showToast('error', 'Error', 'No se pudo registrar salida');
      }
      
      isClockedIn = false;
      clockInTime = null;
      await saveState();
      updateStatusUI();
    }
    
    function showDaySummary(employeeHours) {
      const listEl = document.getElementById('daySummaryList');
      const totalEl = document.getElementById('daySummaryTotal');
      
      let totalMs = 0;
      const items = [];
      
      for (const empId of Object.keys(employeeHours)) {
        const ms = employeeHours[empId] || 0;
        totalMs += ms;
        
        const emp = teamMembers.find(m => m.id === empId) || 
                    (currentEmployee?.id === empId ? currentEmployee : null) ||
                    (currentAdmin?.id === empId ? currentAdmin : null);
        
        const name = emp ? `${emp.firstName} ${emp.lastName}` : 'Empleado';
        const initials = emp ? getInitials(emp.firstName, emp.lastName) : '?';
        const color = emp ? getAvatarColor(emp.firstName + emp.lastName) : '#888';
        
        items.push(`
          <div class="day-summary-item">
            <div class="day-summary-employee">
              <div class="day-summary-avatar" style="background-color:${color}">${initials}</div>
              <span class="day-summary-name">${name}</span>
            </div>
            <span class="day-summary-hours">${msToHoursMinutes(ms)}</span>
          </div>
        `);
      }
      
      listEl.innerHTML = items.join('');
      totalEl.textContent = msToHoursMinutes(totalMs);
      openModal('daySummaryModal');
    }

    // ============================================
    // JOB MANAGEMENT
    // ============================================
    function showStartJobModal(scheduleId) {
      // Auto clock-in if not clocked in (only for non-admins)
      if (!isClockedIn && shouldTrackHours()) clockIn();
      
      const schedule = todaySchedules.find(s => s.id === scheduleId);
      if (!schedule) return;
      
      if (schedule.status === 'completed') { 
        showToast('info', 'Info', 'Trabajo ya completado'); 
        return; 
      }
      if (schedule.status === 'cancelled') { 
        showToast('info', 'Info', 'Trabajo cancelado'); 
        return; 
      }
      if (schedule.status === 'in_progress' && currentJob?.scheduleId !== scheduleId) {
        showToast('info', 'Info', 'Trabajo ya en progreso');
        return;
      }
      
      if (currentJob && currentJob.scheduleId !== scheduleId) {
        if (confirm('¬øDetener trabajo actual e iniciar este?')) {
          stopCurrentJobWithoutComplete();
        } else return;
      }
      
      selectedScheduleId = scheduleId;
      const client = clients[schedule.clientId];
      if (!client) return;
      
      document.getElementById('previewClient').textContent = `${client.firstName} ${client.lastName}`;
      document.getElementById('previewAddress').textContent = `${client.address?.street || ''}, ${client.address?.city || ''}`;
      
      const doorCode = document.getElementById('previewDoorCode');
      if (client.houseCode) {
        doorCode.textContent = `üîë C√≥digo: ${client.houseCode}`;
        doorCode.classList.remove('hidden');
      } else {
        doorCode.classList.add('hidden');
      }
      
      document.getElementById('previewDuration').textContent = `${schedule.estimatedDuration || 2} horas`;
      document.getElementById('previewPrice').textContent = formatCurrency(schedule.serviceDetails?.totalPrice || 0);
      
      const addOns = schedule.serviceDetails?.addOns || [];
      const addonsDiv = document.getElementById('previewAddons');
      if (addOns.length > 0) {
        addonsDiv.classList.remove('hidden');
        const labels = { basement: 'üö™ S√≥tano', mainLevel: 'üè† Nivel Principal', upstairs: '‚¨ÜÔ∏è Arriba' };
        document.getElementById('previewAddonsList').innerHTML = addOns.map(a => {
          const key = typeof a === 'object' ? a.area : a;
          const price = typeof a === 'object' ? a.price : 0;
          return `<span class="job-preview-addon">${labels[key] || key}${price ? ` (+${formatCurrency(price)})` : ''}</span>`;
        }).join('');
      } else {
        addonsDiv.classList.add('hidden');
      }
      
      // Team member selection
      const container = document.getElementById('jobTeamMembers');
      const currentUserId = currentAdmin?.id || currentEmployee?.id;
      const leaderId = currentTeam?.leaderId || currentUserId;
      
      container.innerHTML = teamMembers.map(m => {
        const isLeader = m.id === leaderId;
        const avatarColor = getAvatarColor(m.firstName + m.lastName);
        const initials = getInitials(m.firstName, m.lastName);
        
        return `
          <div class="employee-selection-item ${isLeader ? 'disabled' : 'selected'}" data-emp-id="${m.id}" data-emp-name="${m.firstName} ${m.lastName}" onclick="${isLeader ? '' : 'toggleEmployeeSelection(this)'}">
            <div class="employee-selection-avatar" style="background-color:${avatarColor}">${initials}</div>
            <div class="employee-selection-info">
              <div class="employee-selection-name">${m.firstName} ${m.lastName}</div>
              <div class="employee-selection-role">${isLeader ? '‚≠ê L√≠der del Equipo (requerido)' : 'Miembro'}</div>
            </div>
            <div class="employee-selection-checkbox">‚úî</div>
          </div>
        `;
      }).join('') || '<p class="text-gray-500">Sin miembros de equipo</p>';
      
      openModal('startJobModal');
    }
    
    window.toggleEmployeeSelection = function(element) {
      element.classList.toggle('selected');
      const checkbox = element.querySelector('.employee-selection-checkbox');
      checkbox.innerHTML = element.classList.contains('selected') ? '‚úî' : '';
    };
    
    function getSelectedEmployees() {
      const selectedItems = document.querySelectorAll('.employee-selection-item.selected, .employee-selection-item.disabled');
      return Array.from(selectedItems).map(item => ({
        id: item.dataset.empId,
        name: item.dataset.empName
      }));
    }

    async function stopCurrentJobWithoutComplete() {
      if (!currentJob) return;
      try {
        await updateDoc(doc(db, 'schedules', currentJob.scheduleId), { 
          status: 'scheduled', 
          actualStartTime: null 
        });
        const sch = todaySchedules.find(s => s.id === currentJob.scheduleId);
        if (sch) sch.status = 'scheduled';
        if (jobTimerInterval) { 
          clearInterval(jobTimerInterval); 
          jobTimerInterval = null; 
        }
        currentJob = null;
        jobStartTime = null;
        selectedJobEmployees = [];
        await saveState();
        updateStatusUI();
        renderSchedule();
      } catch (e) { 
        console.error('Stop job error:', e); 
      }
    }

    async function startJob() {
      const schedule = todaySchedules.find(s => s.id === selectedScheduleId);
      if (!schedule || schedule.status === 'completed' || schedule.status === 'in_progress') {
        closeModal('startJobModal');
        return;
      }
      
      const client = clients[schedule.clientId];
      selectedJobEmployees = getSelectedEmployees();
      currentJob = { scheduleId: selectedScheduleId, schedule, client, teamMembers: selectedJobEmployees };
      jobStartTime = new Date();
      
      try {
        await updateDoc(doc(db, 'schedules', selectedScheduleId), {
          status: 'in_progress',
          actualStartTime: Timestamp.fromDate(jobStartTime),
          workingEmployees: selectedJobEmployees.map(e => e.id)
        });
        schedule.status = 'in_progress';
        
        jobTimerInterval = setInterval(updateJobTimer, 1000);
        updateJobTimer();
        
        closeModal('startJobModal');
        showToast('success', 'Iniciado', `Trabajando en ${client.firstName} ${client.lastName}`);
      } catch (e) {
        console.error('Start job error:', e);
        showToast('error', 'Error', 'No se pudo iniciar');
        currentJob = null;
        jobStartTime = null;
        selectedJobEmployees = [];
      }
      
      await saveState();
      updateStatusUI();
      renderSchedule();
    }

    function showCompleteJobModal() {
      if (!currentJob) return;
      
      const client = currentJob.client;
      const schedule = currentJob.schedule;
      
      document.getElementById('completeJobClient').textContent = `${client.firstName} ${client.lastName}`;
      document.getElementById('completeJobAddress').textContent = client.address?.street || '';
      
      const elapsed = Date.now() - jobStartTime.getTime();
      const h = Math.floor(elapsed / 3600000);
      const m = Math.floor((elapsed % 3600000) / 60000);
      const s = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('completeJobTime').textContent = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      
      document.getElementById('paymentAmount').value = schedule.serviceDetails?.totalPrice || '';
      document.getElementById('paymentMethod').value = '';
      document.getElementById('paymentAmountGroup').classList.add('hidden');
      
      openModal('completeJobModal');
    }

    async function completeJob() {
      if (!currentJob) return;
      
      const endTime = new Date();
      const schedule = currentJob.schedule;
      const client = currentJob.client;
      const jobDuration = (endTime - jobStartTime) / 3600000;
      
      try {
        await updateDoc(doc(db, 'schedules', currentJob.scheduleId), {
          status: 'completed',
          actualEndTime: Timestamp.fromDate(endTime),
          notes: document.getElementById('completeJobNotes').value,
          completedEmployees: selectedJobEmployees.map(e => e.id)
        });
        schedule.status = 'completed';
        
        // Save job completion record
        const todayStr = getLocalDateString();
        for (const emp of selectedJobEmployees) {
          await addDoc(collection(db, 'jobCompletions'), {
            date: todayStr,
            employeeId: emp.id,
            employeeName: emp.name,
            scheduleId: currentJob.scheduleId,
            clientId: schedule.clientId,
            clientName: `${client.firstName} ${client.lastName}`,
            startTime: Timestamp.fromDate(jobStartTime),
            endTime: Timestamp.fromDate(endTime),
            duration: jobDuration,
            createdAt: Timestamp.now()
          });
        }
        
        // Handle payment
        const paymentMethod = document.getElementById('paymentMethod').value;
        if (paymentMethod) {
          await addDoc(collection(db, 'payments'), {
            scheduleId: currentJob.scheduleId,
            clientId: schedule.clientId,
            date: Timestamp.now(),
            amount: parseFloat(document.getElementById('paymentAmount').value) || schedule.serviceDetails?.totalPrice || 0,
            paymentMethod,
            status: 'paid',
            createdAt: Timestamp.now()
          });
        }
        
        if (jobTimerInterval) { 
          clearInterval(jobTimerInterval); 
          jobTimerInterval = null; 
        }
        
        await logScheduleAction(AuditActions.UPDATE, currentJob.scheduleId, `Completado: ${client.firstName} ${client.lastName}`);
        
        currentJob = null;
        jobStartTime = null;
        selectedJobEmployees = [];
        
        closeModal('completeJobModal');
        
        // Check if this was the last job
        const remainingJobs = todaySchedules.filter(s => s.status === 'scheduled' || s.status === 'in_progress');
        if (remainingJobs.length === 0 && isClockedIn) {
          showToast('success', '¬°Completado!', '√öltimo trabajo del d√≠a');
          
          if (officeSettings?.start?.street) {
            setTimeout(() => {
              showRoutePrompt(null, 'office');
            }, 500);
          } else {
            setTimeout(() => {
              if (confirm('¬°Todos los trabajos completados! ¬øDesea registrar salida?')) {
                clockOut();
              }
            }, 1000);
          }
        } else {
          showToast('success', '¬°Completado!', 'Excelente trabajo');
        }
      } catch (e) {
        console.error('Complete job error:', e);
        showToast('error', 'Error', 'No se pudo completar');
      }
      
      await saveState();
      updateStatusUI();
      renderSchedule();
    }

    function showCancelJobModal() {
      if (!currentJob) return;
      
      const client = currentJob.client;
      document.getElementById('cancelJobClient').textContent = `${client.firstName} ${client.lastName}`;
      document.getElementById('cancelJobAddress').textContent = client.address?.street || '';
      document.getElementById('cancelReason').value = 'client_cancelled';
      document.getElementById('cancelJobNotes').value = '';
      
      openModal('cancelJobModal');
    }
    
    async function cancelJob() {
      if (!currentJob) return;
      
      const cancelReason = document.getElementById('cancelReason').value;
      const cancelNotes = document.getElementById('cancelJobNotes').value;
      
      try {
        await updateDoc(doc(db, 'schedules', currentJob.scheduleId), {
          status: 'cancelled',
          cancelledAt: Timestamp.now(),
          cancelReason: cancelReason,
          cancelNotes: cancelNotes,
          actualEndTime: Timestamp.now()
        });
        
        currentJob.schedule.status = 'cancelled';
        
        if (jobTimerInterval) { 
          clearInterval(jobTimerInterval); 
          jobTimerInterval = null; 
        }
        
        await logScheduleAction(AuditActions.UPDATE, currentJob.scheduleId, `Cancelado: ${currentJob.client.firstName} ${currentJob.client.lastName} - ${cancelReason}`);
        
        currentJob = null;
        jobStartTime = null;
        selectedJobEmployees = [];
        
        closeModal('cancelJobModal');
        showToast('info', 'Cancelado', 'El trabajo ha sido cancelado');
        
      } catch (e) {
        console.error('Cancel job error:', e);
        showToast('error', 'Error', 'No se pudo cancelar');
      }
      
      await saveState();
      updateStatusUI();
      renderSchedule();
    }

    // ============================================
    // ADMIN STATUS
    // ============================================
    function showAdminStatusModal(scheduleId) {
      adminSelectedScheduleId = scheduleId;
      const schedule = todaySchedules.find(s => s.id === scheduleId);
      if (!schedule) return;
      
      const client = clients[schedule.clientId];
      document.getElementById('adminStatusClient').textContent = client ? `${client.firstName} ${client.lastName}` : 'Desconocido';
      document.getElementById('adminStatusAddress').textContent = client?.address?.street || '';
      document.getElementById('adminNewStatus').value = schedule.status || 'scheduled';
      document.getElementById('adminStatusNotes').value = '';
      
      openModal('adminStatusModal');
    }

    async function updateAdminStatus() {
      if (!adminSelectedScheduleId) return;
      
      const newStatus = document.getElementById('adminNewStatus').value;
      const notes = document.getElementById('adminStatusNotes').value;
      
      try {
        const updateData = { 
          status: newStatus, 
          updatedAt: Timestamp.now() 
        };
        if (notes) updateData.adminNotes = notes;
        if (newStatus === 'completed') updateData.actualEndTime = Timestamp.now();
        
        await updateDoc(doc(db, 'schedules', adminSelectedScheduleId), updateData);
        
        const sch = todaySchedules.find(s => s.id === adminSelectedScheduleId);
        if (sch) sch.status = newStatus;
        
        closeModal('adminStatusModal');
        showToast('success', 'Actualizado', 'Estado cambiado');
        renderSchedule();
      } catch (e) {
        console.error('Update status error:', e);
        showToast('error', 'Error', 'No se pudo actualizar');
      }
    }

    // ============================================
    // UI UPDATES
    // ============================================
    function updateStatusUI() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const btn = document.getElementById('clockBtn');
      const card = document.getElementById('currentJobCard');
      
      dot.className = 'status-dot';
      text.className = 'status-text';
      
      if (!isClockedIn) {
        dot.classList.add('clocked-out');
        text.classList.add('clocked-out');
        text.textContent = 'Sin Registrar';
        btn.className = 'clock-btn clock-in';
        btn.innerHTML = '<span class="clock-btn-icon">‚ñ∂Ô∏è</span><span>Registrar Entrada</span>';
        card.classList.add('hidden');
        document.getElementById('hoursToday').textContent = '0:00';
      } else if (currentJob) {
        dot.classList.add('on-job');
        text.classList.add('on-job');
        text.textContent = 'En Trabajo';
        btn.className = 'clock-btn clock-out';
        btn.innerHTML = '<span class="clock-btn-icon">‚èπÔ∏è</span><span>Registrar Salida</span>';
        card.classList.remove('hidden');
        document.getElementById('currentJobClient').textContent = `${currentJob.client.firstName} ${currentJob.client.lastName}`;
        document.getElementById('currentJobAddress').textContent = `${currentJob.client.address?.street || ''}, ${currentJob.client.address?.city || ''}`;
      } else {
        dot.classList.add('clocked-in');
        text.classList.add('clocked-in');
        text.textContent = 'Registrado';
        btn.className = 'clock-btn clock-out';
        btn.innerHTML = '<span class="clock-btn-icon">‚èπÔ∏è</span><span>Registrar Salida</span>';
        card.classList.add('hidden');
      }
    }

    function renderSchedule() {
      const container = document.getElementById('scheduleList');
      if (!container) return;
      
      if (todaySchedules.length === 0) {
        container.innerHTML = '<div class="empty-schedule"><div class="empty-schedule-icon">üìÖ</div><div>No hay trabajos para hoy</div></div>';
        return;
      }
      
      const sortedSchedules = sortSchedulesByRoute(todaySchedules);
      
      container.innerHTML = sortedSchedules.map((sch, index) => {
        const client = clients[sch.clientId];
        if (!client) return '';
        
        const isActive = currentJob?.scheduleId === sch.id;
        const isCompleted = sch.status === 'completed';
        const isCancelled = sch.status === 'cancelled';
        
        let handler = '';
        if (isAdmin || isSuperAdmin) {
          handler = `onclick="window.showAdminStatusModal('${sch.id}')"`;
        } else if (!isCompleted && !isCancelled && !isActive) {
          handler = `onclick="window.showStartJob('${sch.id}')"`;
        }
        
        const badges = {
          scheduled: '<span class="badge badge-primary">Programado</span>',
          in_progress: '<span class="badge badge-warning">En Progreso</span>',
          completed: '<span class="badge badge-success">Completado</span>',
          cancelled: '<span class="badge badge-secondary">Cancelado</span>',
          rescheduled: '<span class="badge badge-info">Reprogramado</span>'
        };
        
        const doorCode = client.houseCode ? `<div class="schedule-door-code">üîë ${client.houseCode}</div>` : '';
        const addressStr = getAddressFromClient(client);
        const orderNum = index + 1;
        
        return `
          <div class="schedule-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isCancelled ? 'cancelled' : ''}" ${handler}>
            <div class="schedule-order">${isCompleted ? '‚úî' : orderNum}</div>
            <div class="schedule-time">
              <div style="margin-top:6px;"><button class="schedule-nav-btn" data-address="${(addressStr || '').replace(/"/g, '&quot;')}">üß≠ Ir</button></div>
            </div>
            <div class="schedule-info">
              <div class="schedule-client">${client.firstName} ${client.lastName}</div>
              <div class="schedule-address">${client.address?.street || ''}</div>
              ${doorCode}
            </div>
            <div class="schedule-status">
              <div class="schedule-price">${formatCurrency(sch.serviceDetails?.totalPrice || 0)}</div>
              ${badges[sch.status] || ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function sortSchedulesByRoute(schedules) {
      if (!officeSettings?.start?.coordinates) {
        return [...schedules].sort((a, b) => {
          if (a.timeSlot !== b.timeSlot) return a.timeSlot === 'morning' ? -1 : 1;
          return 0;
        });
      }
      
      const scheduled = schedules.filter(s => s.status !== 'cancelled');
      const cancelled = schedules.filter(s => s.status === 'cancelled');
      
      const withCoords = scheduled.filter(s => {
        const client = clients[s.clientId];
        return client?.address?.coordinates;
      });
      const withoutCoords = scheduled.filter(s => {
        const client = clients[s.clientId];
        return !client?.address?.coordinates;
      });
      
      if (withCoords.length <= 1) {
        return [...withCoords, ...withoutCoords, ...cancelled];
      }
      
      // Nearest neighbor algorithm
      const sorted = [];
      let currentPoint = officeSettings.start.coordinates;
      const remaining = [...withCoords];
      
      while (remaining.length > 0) {
        let nearestIdx = 0;
        let nearestDist = Infinity;
        
        for (let i = 0; i < remaining.length; i++) {
          const schedule = remaining[i];
          const client = clients[schedule.clientId];
          const clientCoords = client.address.coordinates;
          const dist = haversine(currentPoint.lat, currentPoint.lng, clientCoords.lat, clientCoords.lng);
          if (dist < nearestDist) {
            nearestDist = dist;
            nearestIdx = i;
          }
        }
        
        const nearest = remaining.splice(nearestIdx, 1)[0];
        sorted.push(nearest);
        const nearestClient = clients[nearest.clientId];
        currentPoint = nearestClient.address.coordinates;
      }
      
      return [...sorted, ...withoutCoords, ...cancelled];
    }

    function renderTeamMembers() {
      const container = document.getElementById('teamMembersList');
      if (!container) return;
      
      container.innerHTML = teamMembers.map(m => {
        const isLeader = currentTeam?.leaderId === m.id;
        return `
          <div class="team-member">
            <div class="team-member-avatar" style="background-color:${getAvatarColor(m.firstName + m.lastName)}">${getInitials(m.firstName, m.lastName)}</div>
            <div class="team-member-info">
              <div class="team-member-name">${m.firstName} ${m.lastName}</div>
              <div class="team-member-role">${isLeader ? '‚≠ê L√≠der' : 'Miembro'}</div>
            </div>
            <div class="team-member-status ${m.isActive ? 'active' : ''}"></div>
          </div>
        `;
      }).join('');
    }

    function showHistory() {
      const container = document.getElementById('historyList');
      let history = [];
      
      timeEntries.forEach(e => {
        if (e.clockIn) {
          const t = e.clockIn?.toDate ? e.clockIn.toDate() : new Date(e.clockIn);
          history.push({ type: 'clock-in', time: t, text: 'Entrada' });
        }
        if (e.clockOut) {
          const t = e.clockOut?.toDate ? e.clockOut.toDate() : new Date(e.clockOut);
          history.push({ type: 'clock-out', time: t, text: 'Salida' });
        }
      });
      
      todaySchedules.filter(s => s.status === 'completed').forEach(s => {
        const client = clients[s.clientId];
        if (s.actualEndTime) {
          const t = s.actualEndTime?.toDate ? s.actualEndTime.toDate() : new Date();
          history.push({ type: 'job', time: t, text: `Completado: ${client?.firstName || ''} ${client?.lastName || ''}` });
        }
      });
      
      history.sort((a, b) => a.time - b.time);
      
      container.innerHTML = history.length === 0
        ? '<div class="text-center text-gray-500 p-4">Sin actividad hoy</div>'
        : history.map(h => `
          <div class="history-item">
            <div class="history-info">
              <div class="history-icon ${h.type}">${h.type === 'clock-in' ? '‚ñ∂Ô∏è' : h.type === 'clock-out' ? '‚èπÔ∏è' : '‚úî'}</div>
              <div>
                <div class="history-text">${h.text}</div>
                <div class="history-time">${formatTime(h.time)}</div>
              </div>
            </div>
          </div>
        `).join('');
      
      openModal('historyModal');
    }

    // ============================================
    // STATE PERSISTENCE
    // ============================================
    async function saveState() {
      const state = {
        isClockedIn,
        clockInTime: clockInTime?.toISOString(),
        currentJob: currentJob ? { scheduleId: currentJob.scheduleId, clientId: currentJob.schedule?.clientId } : null,
        jobStartTime: jobStartTime?.toISOString(),
        selectedJobEmployees,
        sessionId: localStorage.getItem('currentSessionId')
      };
      localStorage.setItem('timeclockState', JSON.stringify(state));
      try { 
        await saveStateToDB(state); 
      } catch (e) { 
        console.error('Save DB error:', e); 
      }
    }

    async function restoreState() {
      try {
        let state = await loadStateFromDB();
        if (!state) {
          const saved = localStorage.getItem('timeclockState');
          if (saved) state = JSON.parse(saved);
        }
        if (!state) return;
        
        const todayStr = getLocalDateString();
        if (state.clockInTime) {
          const savedDate = getLocalDateString(new Date(state.clockInTime));
          if (savedDate !== todayStr) {
            localStorage.removeItem('timeclockState');
            localStorage.removeItem('currentSessionId');
            await clearDBState();
            return;
          }
        }
        
        isClockedIn = state.isClockedIn || false;
        clockInTime = state.clockInTime ? new Date(state.clockInTime) : null;
        selectedJobEmployees = state.selectedJobEmployees || [];
        
        if (state.sessionId) {
          localStorage.setItem('currentSessionId', state.sessionId);
        }
        
        if (state.currentJob && state.jobStartTime) {
          const schedule = todaySchedules.find(s => s.id === state.currentJob.scheduleId);
          if (schedule && schedule.status === 'in_progress') {
            const client = clients[schedule.clientId];
            currentJob = { scheduleId: state.currentJob.scheduleId, schedule, client, teamMembers: selectedJobEmployees };
            jobStartTime = new Date(state.jobStartTime);
            if (!jobTimerInterval) {
              jobTimerInterval = setInterval(updateJobTimer, 1000);
              updateJobTimer();
            }
          }
        }
      } catch (e) { 
        console.error('Restore state error:', e); 
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    function addListenerSafe(id, type, handler) {
      const el = document.getElementById(id);
      if (!el) {
        console.warn('Missing element for event listener:', id);
        return;
      }
      el.addEventListener(type, handler);
    }
    
    window.showStartJob = showStartJobModal;
    window.showAdminStatusModal = showAdminStatusModal;

    function setupEventListeners() {
      addListenerSafe('clockBtn', 'click', () => isClockedIn ? clockOut() : clockIn());
      
      // Refresh button
      addListenerSafe('refreshBtn', 'click', async () => {
        showToast('info', 'Actualizando', 'Cargando datos...');
        await refreshData();
        showToast('success', 'Actualizado', 'Datos actualizados');
      });
      
      // Team selector toggle
      addListenerSafe('teamSelectorBtn', 'click', () => {
        const selector = document.getElementById('teamSelector');
        if (selector) selector.classList.toggle('open');
      });
      
      addListenerSafe('langToggle', 'click', () => {
        i18n.toggleLanguage();
        i18n.updatePageTranslations();
        updateClock();
        updateStatusUI();
        renderSchedule();
      });
      
      addListenerSafe('logoutBtn', 'click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
      });
      
      addListenerSafe('cancelJobBtn', 'click', showCancelJobModal);
      addListenerSafe('completeJobBtn', 'click', showCompleteJobModal);
      
      addListenerSafe('closeStartJobModal', 'click', () => closeModal('startJobModal'));
      addListenerSafe('cancelStartJobBtn', 'click', () => closeModal('startJobModal'));
      addListenerSafe('confirmStartJobBtn', 'click', startJob);
      
      addListenerSafe('closeCompleteJobModal', 'click', () => closeModal('completeJobModal'));
      addListenerSafe('cancelCompleteJobBtn', 'click', () => closeModal('completeJobModal'));
      addListenerSafe('confirmCompleteJobBtn', 'click', completeJob);
      
      addListenerSafe('closeCancelJobModal', 'click', () => closeModal('cancelJobModal'));
      addListenerSafe('cancelCancelJobBtn', 'click', () => closeModal('cancelJobModal'));
      addListenerSafe('confirmCancelJobBtn', 'click', cancelJob);
      
      addListenerSafe('closeDaySummaryModal', 'click', () => closeModal('daySummaryModal'));
      addListenerSafe('closeDaySummaryBtn', 'click', () => closeModal('daySummaryModal'));
      
      addListenerSafe('routeDismissBtn', 'click', () => {
        document.getElementById('routePrompt').classList.add('hidden');
      });
      
      addListenerSafe('routeDirectionsBtn', 'click', () => {
        const promptEl = document.getElementById('routePrompt');
        const type = promptEl.dataset.type;
        let address = '';
        
        if (type === 'office') {
          address = officeSettings?.start?.street;
          if (officeSettings?.start?.city) address += ', ' + officeSettings.start.city;
        } else {
          const clientId = promptEl.dataset.clientId;
          const client = clients[clientId];
          if (client?.address) {
            address = client.address.street;
            if (client.address.city) address += ', ' + client.address.city;
          }
        }
        
        if (address) openDirections(address);
        promptEl.classList.add('hidden');
      });
      
      addListenerSafe('paymentMethod', 'change', (e) => {
        document.getElementById('paymentAmountGroup').classList.toggle('hidden', !e.target.value);
      });
      
      addListenerSafe('closeHistoryModal', 'click', () => closeModal('historyModal'));
      addListenerSafe('closeHistoryBtn', 'click', () => closeModal('historyModal'));
      
      addListenerSafe('closeAdminStatusModal', 'click', () => closeModal('adminStatusModal'));
      addListenerSafe('cancelAdminStatusBtn', 'click', () => closeModal('adminStatusModal'));
      addListenerSafe('confirmAdminStatusBtn', 'click', updateAdminStatus);
      
      addListenerSafe('adminTeamFilter', 'change', async () => {
        await loadTodaySchedules();
        renderSchedule();
      });

      addListenerSafe('navigateJobBtn', 'click', () => {
        if (!currentJob) return showToast('info', 'Sin Trabajo', 'No hay trabajo en curso');
        const addr = getAddressFromClient(currentJob.client);
        if (addr) openDirections(addr);
      });

      // Event delegation for per-schedule navigate buttons
      document.addEventListener('click', (ev) => {
        const target = ev.target.closest && ev.target.closest('.schedule-nav-btn');
        if (target) {
          ev.stopPropagation();
          const addr = target.dataset.address;
          if (addr) openDirections(addr);
        }
      });
      
      document.getElementById('modalBackdrop')?.addEventListener('click', closeAllModals);
      
      document.getElementById('locationDismissBtn')?.addEventListener('click', () => {
        document.getElementById('locationPrompt').classList.add('hidden');
        nearbySchedule = null;
      });
      
      document.getElementById('locationStartBtn')?.addEventListener('click', () => {
        document.getElementById('locationPrompt').classList.add('hidden');
        if (nearbySchedule) showStartJobModal(nearbySchedule.id);
      });
    }
  </script>
</body>
</html>