<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mendez Cleaning - Finances</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Finance-specific styles */
    .finance-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    @media (max-width: 1024px) {
      .finance-summary {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .finance-summary {
        grid-template-columns: 1fr;
      }
    }
    
    .summary-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      border: 1px solid var(--gray-200);
    }
    
    .summary-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
    }
    
    .summary-card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
    }
    
    .summary-card-icon.revenue {
      background: var(--success-100);
    }
    
    .summary-card-icon.expenses {
      background: var(--danger-100);
    }
    
    .summary-card-icon.profit {
      background: var(--primary-100);
    }
    
    .summary-card-icon.pending {
      background: var(--warning-100);
    }
    
    .summary-card-trend {
      font-size: var(--text-sm);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-weight: 500;
    }
    
    .summary-card-trend.up {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .summary-card-trend.down {
      background: var(--danger-100);
      color: var(--danger-700);
    }
    
    .summary-card-value {
      font-size: var(--text-3xl);
      font-weight: 700;
      margin-bottom: var(--space-1);
    }
    
    .summary-card-value.revenue {
      color: var(--success-600);
    }
    
    .summary-card-value.expenses {
      color: var(--danger-600);
    }
    
    .summary-card-value.profit {
      color: var(--primary-600);
    }
    
    .summary-card-value.pending {
      color: var(--warning-600);
    }
    
    .summary-card-label {
      color: var(--gray-500);
      font-size: var(--text-sm);
    }
    
    /* Date range selector */
    .date-range-selector {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }
    
    .date-range-btn {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .date-range-btn:hover {
      background: var(--gray-50);
    }
    
    .date-range-btn.active {
      background: var(--primary-600);
      border-color: var(--primary-600);
      color: white;
    }
    
    /* Invoice preview */
    .invoice-preview {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 2px solid var(--gray-200);
    }
    
    .invoice-logo {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--primary-600);
    }
    
    .invoice-title {
      text-align: right;
    }
    
    .invoice-title h2 {
      font-size: var(--text-2xl);
      color: var(--gray-800);
      margin-bottom: var(--space-2);
    }
    
    .invoice-number {
      font-size: var(--text-lg);
      color: var(--gray-500);
    }
    
    .invoice-parties {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-8);
      margin-bottom: var(--space-8);
    }
    
    .invoice-party-label {
      font-size: var(--text-sm);
      color: var(--gray-500);
      text-transform: uppercase;
      margin-bottom: var(--space-2);
    }
    
    .invoice-party-name {
      font-weight: 600;
      font-size: var(--text-lg);
      margin-bottom: var(--space-1);
    }
    
    .invoice-party-details {
      color: var(--gray-600);
      font-size: var(--text-sm);
      line-height: 1.6;
    }
    
    .invoice-meta {
      display: flex;
      gap: var(--space-8);
      margin-bottom: var(--space-6);
    }
    
    .invoice-meta-item {
      flex: 1;
    }
    
    .invoice-meta-label {
      font-size: var(--text-sm);
      color: var(--gray-500);
      margin-bottom: var(--space-1);
    }
    
    .invoice-meta-value {
      font-weight: 600;
    }
    
    .invoice-table {
      width: 100%;
      margin-bottom: var(--space-6);
    }
    
    .invoice-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      background: var(--gray-50);
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
    }
    
    .invoice-table th:last-child {
      text-align: right;
    }
    
    .invoice-table td {
      padding: var(--space-4);
      border-bottom: 1px solid var(--gray-100);
    }
    
    .invoice-table td:last-child {
      text-align: right;
      font-weight: 500;
    }
    
    .invoice-totals {
      display: flex;
      justify-content: flex-end;
      margin-bottom: var(--space-8);
    }
    
    .invoice-totals-table {
      width: 300px;
    }
    
    .invoice-totals-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
    }
    
    .invoice-totals-row.total {
      border-top: 2px solid var(--gray-200);
      margin-top: var(--space-2);
      padding-top: var(--space-3);
      font-size: var(--text-xl);
      font-weight: 700;
    }
    
    .invoice-totals-row.total .amount {
      color: var(--primary-600);
    }
    
    .invoice-footer {
      text-align: center;
      padding-top: var(--space-6);
      border-top: 1px solid var(--gray-200);
      color: var(--gray-500);
      font-size: var(--text-sm);
    }
    
    /* Expense category icons */
    .expense-category-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
    }
    
    .expense-category-icon.supplies { background: var(--info-100); }
    .expense-category-icon.equipment { background: var(--warning-100); }
    .expense-category-icon.vehicle { background: var(--success-100); }
    .expense-category-icon.insurance { background: var(--danger-100); }
    .expense-category-icon.payroll { background: var(--primary-100); }
    .expense-category-icon.marketing { background: var(--secondary-100); }
    .expense-category-icon.office { background: var(--gray-100); }
    .expense-category-icon.other { background: var(--gray-100); }

    /* Status dropdown for payments/invoices */
    .status-select {
      padding: 4px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-300);
      font-size: var(--text-sm);
      cursor: pointer;
      min-width: 100px;
    }
    .status-select.paid { background: var(--success-100); border-color: var(--success-300); color: var(--success-700); }
    .status-select.pending { background: var(--warning-100); border-color: var(--warning-300); color: var(--warning-700); }
    .status-select.overdue { background: var(--danger-100); border-color: var(--danger-300); color: var(--danger-700); }
    .status-select.draft { background: var(--gray-100); border-color: var(--gray-300); color: var(--gray-700); }
    .status-select.sent { background: var(--info-100); border-color: var(--info-300); color: var(--info-700); }
    
    /* Source badge for payments */
    .source-badge {
      font-size: var(--text-xs);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      background: var(--info-100);
      color: var(--info-700);
    }

    @media print {
      body * { visibility: hidden; }
      #invoicePreviewModal { position: fixed !important; left: 0 !important; top: 0 !important; width: 100% !important; height: auto !important; margin: 0 !important; padding: 0 !important; background: white !important; z-index: 99999 !important; overflow: visible !important; }
      #invoicePreviewModal, #invoicePreviewModal * { visibility: visible !important; }
      #invoicePreviewModal .modal-header, #invoicePreviewModal .modal-footer { display: none !important; }
      #invoicePreviewContent { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; padding: 20px !important; margin: 0 !important; overflow: visible !important; }
      .invoice-preview { border: none !important; box-shadow: none !important; max-width: 100% !important; padding: 20px !important; }
      .modal-backdrop { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">üßπ</div>
        <span class="sidebar-title">Mendez Cleaning</span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a href="dashboard.html" class="nav-item">
            <span class="nav-item-icon">üìä</span>
            <span class="nav-item-text" data-i18n="dashboard">Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Management</div>
          <a href="employees.html" class="nav-item">
            <span class="nav-item-icon">üë•</span>
            <span class="nav-item-text" data-i18n="employees">Employees</span>
          </a>
          <a href="clients.html" class="nav-item">
            <span class="nav-item-icon">üè†</span>
            <span class="nav-item-text" data-i18n="clients">Clients</span>
          </a>
          <a href="scheduling.html" class="nav-item">
            <span class="nav-item-icon">üìÖ</span>
            <span class="nav-item-text" data-i18n="scheduling">Scheduling</span>
          </a>
          <a href="employee-hours.html" class="nav-item">
            <span class="nav-item-icon">‚è∞</span>
            <span class="nav-item-text" data-i18n="employeeHours">Employee Hours</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title" data-i18n="app">App</div>
          <a href="timeclock.html" class="nav-item">
            <span class="nav-item-icon">‚è±Ô∏è</span>
            <span class="nav-item-text" data-i18n="app">App</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title" data-i18n="finances">Finance</div>
          <a href="finances.html" class="nav-item active">
            <span class="nav-item-icon">üí∞</span>
            <span class="nav-item-text" data-i18n="finances">Finances</span>
          </a>
          <a href="reports.html" class="nav-item">
            <span class="nav-item-icon">üìà</span>
            <span class="nav-item-text" data-i18n="reports">Reports</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <a href="audit-log.html" class="nav-item">
            <span class="nav-item-icon">üìã</span>
            <span class="nav-item-text" data-i18n="auditLog">Audit Log</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-avatar" id="userAvatar">AD</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="userName">Admin</div>
            <div class="sidebar-user-role" id="userRole">Administrator</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="header-menu-btn" id="menuToggle">‚ò∞</button>
        
        <div class="header-search">
          <span class="header-search-icon">üîç</span>
          <input type="text" class="header-search-input" placeholder="Search transactions..." id="searchInput">
        </div>

        <div class="header-actions">
          <button class="header-btn lang-toggle" id="langToggle">
            üåê <span id="langLabel">ES</span>
          </button>
          <button class="header-btn" id="logoutBtn" title="Logout">üö™</button>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title" data-i18n="finances">Finances</h1>
            <p class="text-gray-500">Track revenue, expenses, and profitability</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" id="companySettingsBtn">
              <span>‚öôÔ∏è</span>
              <span>Company Settings</span>
            </button>
            <button class="btn btn-secondary" id="addExpenseBtn">
              <span>üí∏</span>
              <span data-i18n="addExpense">Add Expense</span>
            </button>
            <button class="btn btn-primary" id="createInvoiceBtn">
              <span>üìÑ</span>
              <span data-i18n="createInvoice">Create Invoice</span>
            </button>
          </div>
        </div>

        <!-- Date Range Selector -->
        <div class="date-range-selector">
          <button class="date-range-btn" data-range="today">Today</button>
          <button class="date-range-btn active" data-range="week">This Week</button>
          <button class="date-range-btn" data-range="month">This Month</button>
          <button class="date-range-btn" data-range="year">This Year</button>
          <button class="date-range-btn" data-range="custom">Custom</button>
          <div class="hidden" id="customDateRange">
            <input type="date" class="form-input" id="startDate" style="width: auto;">
            <span>to</span>
            <input type="date" class="form-input" id="endDate" style="width: auto;">
            <button class="btn btn-sm btn-primary" id="applyDateRange">Apply</button>
          </div>
        </div>

        <!-- Financial Summary -->
        <div class="finance-summary">
          <div class="summary-card">
            <div class="summary-card-header">
              <div class="summary-card-icon revenue">üíµ</div>
              <span class="summary-card-trend up" id="revenueTrend">‚Üë 12%</span>
            </div>
            <div class="summary-card-value revenue" id="totalRevenue">$0.00</div>
            <div class="summary-card-label" data-i18n="totalRevenue">Total Revenue</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-header">
              <div class="summary-card-icon expenses">üí∏</div>
              <span class="summary-card-trend down" id="expensesTrend">‚Üì 5%</span>
            </div>
            <div class="summary-card-value expenses" id="totalExpenses">$0.00</div>
            <div class="summary-card-label" data-i18n="totalExpenses">Total Expenses</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-header">
              <div class="summary-card-icon profit">üìà</div>
              <span class="summary-card-trend up" id="profitTrend">‚Üë 18%</span>
            </div>
            <div class="summary-card-value profit" id="netProfit">$0.00</div>
            <div class="summary-card-label" data-i18n="netProfit">Net Profit</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-header">
              <div class="summary-card-icon pending">‚è≥</div>
            </div>
            <div class="summary-card-value pending" id="pendingPayments">$0.00</div>
            <div class="summary-card-label" data-i18n="pendingPayments">Pending Payments</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs mb-4">
          <button class="tab active" data-tab="payments" data-i18n="payments">Payments</button>
          <button class="tab" data-tab="completedJobs">Completed Jobs</button>
          <button class="tab" data-tab="expenses" data-i18n="expenses">Expenses</button>
          <button class="tab" data-tab="invoices" data-i18n="invoices">Invoices</button>
        </div>

        <!-- Payments Tab -->
        <div class="tab-content active" id="paymentsTab">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="recentPayments">Recent Payments</h3>
              <div class="flex gap-2">
                <select class="form-select" id="paymentStatusFilter" style="width: auto;">
                  <option value="">All Status</option>
                  <option value="paid">Paid</option>
                  <option value="pending">Pending</option>
                  <option value="overdue">Overdue</option>
                </select>
                <select class="form-select" id="paymentSourceFilter" style="width: auto;">
                  <option value="">All Sources</option>
                  <option value="cleaning">Cleaning Jobs</option>
                  <option value="invoice">Invoices</option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table class="table" id="paymentsTable">
                <thead>
                  <tr>
                    <th data-i18n="date">Date</th>
                    <th data-i18n="clients">Client</th>
                    <th data-i18n="serviceType">Service</th>
                    <th data-i18n="paymentMethod">Method</th>
                    <th data-i18n="amount">Amount</th>
                    <th data-i18n="status">Status</th>
                    <th data-i18n="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="paymentsBody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="empty-state hidden" id="noPayments">
              <div class="empty-state-icon">üí≥</div>
              <div class="empty-state-title">No payments found</div>
              <p class="text-gray-500">Payments will appear here when jobs are completed</p>
            </div>
          </div>
        </div>


        <!-- Completed Jobs Tab -->
        <div class="tab-content" id="completedJobsTab">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Completed Jobs</h3>
              <select class="form-select" id="completedJobsFilter" style="width: auto;">
                <option value="">All Payment Status</option>
                <option value="paid">Paid</option>
                <option value="pending">Pending Payment</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
            <div class="table-container">
              <table class="table" id="completedJobsTable">
                <thead>
                  <tr>
                    <th>Completed Date</th>
                    <th data-i18n="clients">Client</th>
                    <th>Address</th>
                    <th>Service</th>
                    <th data-i18n="amount">Amount</th>
                    <th>Payment Status</th>
                    <th data-i18n="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="completedJobsBody"></tbody>
              </table>
            </div>
            <div class="empty-state hidden" id="noCompletedJobs">
              <div class="empty-state-icon">üè†</div>
              <div class="empty-state-title">No completed jobs found</div>
              <p class="text-gray-500">Completed cleaning jobs will appear here</p>
            </div>
          </div>
        </div>
        <!-- Expenses Tab -->
        <div class="tab-content" id="expensesTab">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="expenses">Expenses</h3>
              <select class="form-select" id="expenseCategoryFilter" style="width: auto;">
                <option value="">All Categories</option>
                <option value="supplies">Supplies</option>
                <option value="equipment">Equipment</option>
                <option value="vehicle">Vehicle</option>
                <option value="insurance">Insurance</option>
                <option value="payroll">Payroll</option>
                <option value="marketing">Marketing</option>
                <option value="office">Office</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="table-container">
              <table class="table" id="expensesTable">
                <thead>
                  <tr>
                    <th data-i18n="date">Date</th>
                    <th data-i18n="category">Category</th>
                    <th data-i18n="description">Description</th>
                    <th data-i18n="vendor">Vendor</th>
                    <th data-i18n="amount">Amount</th>
                    <th data-i18n="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="expensesBody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="empty-state hidden" id="noExpenses">
              <div class="empty-state-icon">üí∏</div>
              <div class="empty-state-title">No expenses recorded</div>
              <p class="text-gray-500">Track your business expenses here</p>
              <button class="btn btn-primary mt-4" id="addFirstExpenseBtn">
                <span>‚ûï</span>
                <span data-i18n="addExpense">Add Expense</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Invoices Tab -->
        <div class="tab-content" id="invoicesTab">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="invoices">Invoices</h3>
              <select class="form-select" id="invoiceStatusFilter" style="width: auto;">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
            <div class="table-container">
              <table class="table" id="invoicesTable">
                <thead>
                  <tr>
                    <th>Invoice #</th>
                    <th data-i18n="clients">Client</th>
                    <th data-i18n="date">Date</th>
                    <th data-i18n="dueDate">Due Date</th>
                    <th data-i18n="amount">Amount</th>
                    <th data-i18n="status">Status</th>
                    <th data-i18n="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="invoicesBody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="empty-state hidden" id="noInvoices">
              <div class="empty-state-icon">üìÑ</div>
              <div class="empty-state-title">No invoices yet</div>
              <p class="text-gray-500">Create invoices for clients who require them</p>
              <button class="btn btn-primary mt-4" id="createFirstInvoiceBtn">
                <span>‚ûï</span>
                <span data-i18n="createInvoice">Create Invoice</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div class="modal-backdrop" id="sidebarOverlay"></div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" id="modalBackdrop"></div>

  <!-- Add/Edit Expense Modal -->
  <div class="modal modal-lg" id="expenseModal">
    <div class="modal-header">
      <h3 class="modal-title" id="expenseModalTitle" data-i18n="addExpense">Add Expense</h3>
      <button class="modal-close" id="closeExpenseModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="expenseForm">
        <input type="hidden" id="expenseId">
        
        <div class="grid grid-cols-2">
          <div class="form-group">
            <label class="form-label form-label-required" data-i18n="date">Date</label>
            <input type="date" class="form-input" id="expenseDate" required>
          </div>
          <div class="form-group">
            <label class="form-label form-label-required" data-i18n="category">Category</label>
            <select class="form-select" id="expenseCategory" required>
              <option value="">Select Category</option>
              <option value="supplies">üß¥ Supplies</option>
              <option value="equipment">üîß Equipment</option>
              <option value="vehicle">üöó Vehicle</option>
              <option value="insurance">üõ°Ô∏è Insurance</option>
              <option value="payroll">üíµ Payroll</option>
              <option value="marketing">üì¢ Marketing</option>
              <option value="office">üè¢ Office</option>
              <option value="other">üì¶ Other</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label form-label-required" data-i18n="description">Description</label>
          <input type="text" class="form-input" id="expenseDescription" required placeholder="e.g., Cleaning supplies from Amazon">
        </div>

        <div class="grid grid-cols-2">
          <div class="form-group">
            <label class="form-label form-label-required" data-i18n="amount">Amount</label>
            <div class="input-group">
              <span class="input-group-prepend">$</span>
              <input type="number" class="form-input" id="expenseAmount" step="0.01" min="0" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="vendor">Vendor</label>
            <input type="text" class="form-input" id="expenseVendor" placeholder="e.g., Amazon, Home Depot">
          </div>
        </div>

        <div class="form-group">
          <label class="toggle">
            <input type="checkbox" class="toggle-input" id="expenseRecurring">
            <span class="toggle-slider"></span>
            <span class="toggle-label">Recurring Expense</span>
          </label>
        </div>

        <div class="form-group hidden" id="recurringOptions">
          <label class="form-label">Recurring Frequency</label>
          <select class="form-select" id="expenseFrequency">
            <option value="weekly">Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="notes">Notes</label>
          <textarea class="form-input" id="expenseNotes" rows="2" placeholder="Additional details..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelExpenseBtn" data-i18n="cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="saveExpenseBtn" data-i18n="save">Save</button>
    </div>
  </div>

  <!-- Record Payment Modal -->
  <div class="modal" id="paymentModal">
    <div class="modal-header">
      <h3 class="modal-title" data-i18n="recordPayment">Record Payment</h3>
      <button class="modal-close" id="closePaymentModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="paymentForm">
        <input type="hidden" id="paymentId">
        
        <div class="form-group">
          <label class="form-label" data-i18n="paymentMethod">Payment Method</label>
          <select class="form-select" id="recordPaymentMethod" onchange="toggleCustomPaymentMethod()">
            <option value="cash">üíµ Cash</option>
            <option value="check">üìù Check</option>
            <option value="card">üí≥ Card</option>
            <option value="venmo">üì± Venmo</option>
            <option value="zelle">üì≤ Zelle</option>
            <option value="other">üìã Other</option>
          </select>
        </div>

        <div class="form-group hidden" id="customPaymentMethodGroup">
          <label class="form-label">Payment Method Name</label>
          <input type="text" class="form-input" id="customPaymentMethod" placeholder="e.g., Wire Transfer, ACH, etc.">
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="amount">Amount</label>
          <div class="input-group">
            <span class="input-group-prepend">$</span>
            <input type="number" class="form-input" id="recordPaymentAmount" step="0.01" min="0">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="notes">Notes</label>
          <textarea class="form-input" id="recordPaymentNotes" rows="2"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelPaymentBtn" data-i18n="cancel">Cancel</button>
      <button type="button" class="btn btn-success" id="savePaymentBtn">Mark as Paid</button>
    </div>
  </div>

  <!-- Create Invoice Modal -->
  <div class="modal modal-xl" id="invoiceModal">
    <div class="modal-header">
      <h3 class="modal-title" data-i18n="createInvoice">Create Invoice</h3>
      <button class="modal-close" id="closeInvoiceModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="invoiceForm">
        <input type="hidden" id="invoiceId">
        
        <div class="grid grid-cols-2 mb-4">
          <div class="form-group">
            <label class="form-label form-label-required" data-i18n="selectClient">Select Client</label>
            <select class="form-select" id="invoiceClient" required>
              <option value="">-- Select Client --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Invoice Number</label>
            <input type="text" class="form-input" id="invoiceNumber" readonly>
          </div>
        </div>

        <div class="grid grid-cols-2 mb-4">
          <div class="form-group">
            <label class="form-label" data-i18n="invoiceDate">Invoice Date</label>
            <input type="date" class="form-input" id="invoiceDate">
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="dueDate">Due Date</label>
            <input type="date" class="form-input" id="invoiceDueDate">
          </div>
        </div>

        <!-- Tax Settings -->
        <div class="grid grid-cols-2 mb-4">
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="invoiceTaxEnabled">
              <span class="checkbox-label">Apply Tax</span>
            </label>
            <small class="text-gray-500">Enable to apply tax to this invoice</small>
          </div>
          <div class="form-group">
            <label class="form-label">Tax Percentage</label>
            <div class="input-with-suffix">
              <input type="number" class="form-input" id="invoiceTaxPercentage" min="0" max="100" step="0.01" placeholder="5.00">
              <span class="input-suffix">%</span>
            </div>
          </div>
        </div>

        <!-- Invoice Items -->
        <div class="form-group">
          <label class="form-label">Invoice Items</label>
          <div class="card">
            <div class="table-container">
              <table class="table" id="invoiceItemsTable">
                <thead>
                  <tr>
                    <th style="width: 60%;">Description</th>
                    <th>Rate</th>
                    <th>Amount</th>
                    <th style="width: 50px;"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="p-3">
              <button type="button" class="btn btn-ghost btn-sm" id="addInvoiceItemBtn">
                ‚ûï Add Item
              </button>
            </div>
          </div>
        </div>

        <!-- Invoice Totals -->
        <div class="flex justify-end">
          <div style="width: 300px;">
            <div class="flex justify-between p-2">
              <span>Subtotal</span>
              <span id="invoiceSubtotal">$0.00</span>
            </div>
            <div class="flex justify-between p-2">
              <span>Tax (0%)</span>
              <span id="invoiceTax">$0.00</span>
            </div>
            <div class="flex justify-between p-2 border-t font-semibold text-lg">
              <span>Total</span>
              <span class="text-primary" id="invoiceTotal">$0.00</span>
            </div>
          </div>
        </div>

        <div class="form-group mt-4">
          <label class="form-label" data-i18n="notes">Notes</label>
          <textarea class="form-input" id="invoiceNotes" rows="2" placeholder="Payment terms, thank you note, etc."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelInvoiceBtn" data-i18n="cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="saveInvoiceBtn" data-i18n="save">Save Invoice</button>
    </div>
  </div>

  <!-- Invoice Preview Modal -->
  <div class="modal modal-xl" id="invoicePreviewModal">
    <div class="modal-header">
      <h3 class="modal-title">Invoice Preview</h3>
      <button class="modal-close" id="closePreviewModal">‚úï</button>
    </div>
    <div class="modal-body" id="invoicePreviewContent">
      <!-- Populated by JS -->
    </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="closePreviewBtn" data-i18n="close">Close</button>
        <button type="button" class="btn btn-info" id="sendInvoiceBtn">üìß Send Invoice</button>
        <button type="button" class="btn btn-primary" id="printInvoiceBtn">üñ®Ô∏è Print</button>
      </div>
  </div>

  <!-- Send Invoice Modal -->
  <div class="modal" id="sendInvoiceModal">
    <div class="modal-header">
      <h3 class="modal-title">Send Invoice</h3>
      <button class="modal-close" id="closeSendInvoiceModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="sendInvoiceForm">
        <div class="form-group">
          <label class="form-label form-label-required">Recipient Email</label>
          <input type="email" class="form-input" id="sendInvoiceEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="sendInvoiceSubject" value="Invoice from Mendez Cleaning">
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-input" id="sendInvoiceMessage" rows="4">Please find attached your invoice. Payment is due within 7 days.</textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelSendInvoiceBtn">Cancel</button>
      <button type="button" class="btn btn-primary" id="confirmSendInvoiceBtn">üìß Send Invoice</button>
    </div>
  </div>

  <!-- Quick Add Schedule Modal -->
  <div class="modal" id="quickAddScheduleModal">
    <div class="modal-header">
      <h3 class="modal-title">Add to Schedule</h3>
      <button class="modal-close" id="closeQuickAddScheduleModal">‚úï</button>
    </div>
    <div class="modal-body" id="quickAddScheduleBody">
      <!-- Content will be populated by JavaScript -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelQuickAddScheduleBtn">Cancel</button>
      <button type="button" class="btn btn-primary" id="confirmQuickAddScheduleBtn">Add & Link</button>
    </div>
  </div>

  <!-- Link Invoice to Schedule Modal -->
  <div class="modal" id="linkInvoiceToScheduleModal">
    <div class="modal-header">
      <h3 class="modal-title">Link Invoice to Schedule</h3>
      <button class="modal-close" id="closeLinkInvoiceToScheduleModal">‚úï</button>
    </div>
    <div class="modal-body" id="linkInvoiceToScheduleBody">
      <!-- Content will be populated by JavaScript -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelLinkInvoiceBtn">Cancel</button>
    </div>
  </div>

  <!-- Company Settings Modal -->
  <div class="modal modal-lg" id="companySettingsModal">
    <div class="modal-header">
      <h3 class="modal-title">Company Settings</h3>
      <button class="modal-close" id="closeCompanySettingsModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="companySettingsForm">
        <!-- Company Info Section -->
        <h4>Company Information</h4>
        <div class="form-group">
          <label class="form-label form-label-required">Company Name</label>
          <input type="text" class="form-input" id="settingsCompanyName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Tagline</label>
          <input type="text" class="form-input" id="settingsTagline">
        </div>
        <div class="form-group">
          <label class="form-label form-label-required">Phone Number</label>
          <input type="tel" class="form-input" id="settingsPhone" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="settingsEmail">
        </div>
        <div class="form-group">
          <label class="form-label form-label-required">Street Address</label>
          <input type="text" class="form-input" id="settingsAddress" required>
        </div>
        <div class="grid grid-cols-3">
          <div class="form-group">
            <label class="form-label form-label-required">City</label>
            <input type="text" class="form-input" id="settingsCity" required>
          </div>
          <div class="form-group">
            <label class="form-label form-label-required">State</label>
            <input type="text" class="form-input" id="settingsState" required>
          </div>
          <div class="form-group">
            <label class="form-label form-label-required">ZIP Code</label>
            <input type="text" class="form-input" id="settingsZip" required>
          </div>
        </div>

        <!-- Email Template Section -->
        <h4 class="mt-6">Invoice Email Template</h4>
        <div class="form-group">
          <label class="form-label form-label-required">Default Subject Line</label>
          <input type="text" class="form-input" id="settingsEmailSubject" required>
          <small class="text-gray-500">Use {invoiceNumber} as placeholder</small>
        </div>
        <div class="form-group">
          <label class="form-label form-label-required">Default Message</label>
          <textarea class="form-input" id="settingsEmailMessage" rows="4" required></textarea>
          <small class="text-gray-500">Use {invoiceNumber}, {amount}, {dueDate} as placeholders</small>
        </div>

        <!-- Tax Settings Section -->
        <h4 class="mt-6">Tax Settings</h4>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="settingsTaxEnabled">
            <span class="checkbox-label">Enable Tax on Invoices</span>
          </label>
          <small class="text-gray-500">Enable this to apply default tax percentage to invoices (can be overridden per invoice)</small>
        </div>
        <div class="form-group">
          <label class="form-label">Default Tax Percentage</label>
          <div class="input-with-suffix">
            <input type="number" class="form-input" id="settingsTaxPercentage" min="0" max="100" step="0.01" placeholder="5.00">
            <span class="input-suffix">%</span>
          </div>
          <small class="text-gray-500">Default tax percentage to apply to invoices (e.g., 5.00 for 5%)</small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
      <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    import {
      auth, db, onAuthStateChanged, signOut,
      collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, setDoc,
      query, where, orderBy, Timestamp
    } from './js/firebase-config.js';
    import { i18n } from './js/i18n.js';
    import { 
      showToast, openModal, closeModal, closeAllModals,
      formatCurrency, formatDate, getInitials, confirmDialog, debounce
    } from './js/utils.js';
    import { logExpenseAction, logPaymentAction, AuditActions } from './js/audit.js';

    // ============================================
    // STATE
    // ============================================
    let currentUser = null;
    let currentAdmin = null;
    let clients = {};
    let payments = [];
    let expenses = [];
    let invoices = [];
    let schedules = [];
    let completedSchedules = [];
    let teams = [];
    
    let currentDateRange = 'week';
    let startDate = null;
    let endDate = null;
    let editingExpenseId = null;
    let editingPaymentId = null;
    let invoiceItems = [];
    let currentInvoiceId = null;
    let companyInfo = null;
    let invoiceEmailTemplate = null;

    // ============================================
    // HELPER DATE FUNCTION
    // ============================================
    function toLocalDateString(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }

    // ============================================
    // AUTHENTICATION CHECK
    // ============================================
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        try {
          const adminDoc = await getDoc(doc(db, 'admins', user.uid));
          if (adminDoc.exists()) {
            currentAdmin = { id: adminDoc.id, ...adminDoc.data() };
            initializePage();
          } else {
            window.location.href = 'index.html';
          }
        } catch (error) {
          
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    // ============================================
    // INITIALIZE PAGE
    // ============================================
    async function initializePage() {
      document.getElementById('userName').textContent = currentAdmin.name;
      document.getElementById('userAvatar').textContent = getInitials(
        currentAdmin.name.split(' ')[0], 
        currentAdmin.name.split(' ')[1] || ''
      );

      updateLanguage();
      i18n.updatePageTranslations();

      // Set default date range
      setDateRange('week');

      // Load data
      await loadClients();
      await loadTeams();
      await loadCompanySettings();
      await loadData();

      // Auto-update payment statuses (overdue for cleanings immediately, invoices after 1 week)
      await autoUpdatePaymentStatuses();

      setupEventListeners();

      // Check URL params
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('action') === 'expense') {
        openExpenseModal();
      }
    }

    // ============================================
    // AUTO UPDATE PAYMENT STATUSES
    // ============================================
    async function autoUpdatePaymentStatuses() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let updatedCount = 0;
      
      // Update cleaning job payments - overdue immediately if not paid same day
      for (const payment of payments) {
        if (payment.status === 'pending' && !payment.invoiceId) {
          const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date(payment.date);
          paymentDate.setHours(0, 0, 0, 0);
          if (paymentDate < today) {
            try {
              await updateDoc(doc(db, 'payments', payment.id), { status: 'overdue', updatedAt: Timestamp.now() });
              payment.status = 'overdue';
              updatedCount++;
            } catch (error) {  }
          }
        }
      }
      
      // Update invoice-linked payments - overdue after due date (1 week)
      for (const invoice of invoices) {
        if (invoice.status === 'sent') {
          const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);
          dueDate.setHours(0, 0, 0, 0);
          if (dueDate < today) {
            try {
              await updateDoc(doc(db, 'invoices', invoice.id), { status: 'overdue', updatedAt: Timestamp.now() });
              invoice.status = 'overdue';
              const linkedPayment = payments.find(p => p.invoiceId === invoice.id);
              if (linkedPayment && linkedPayment.status !== 'paid') {
                await updateDoc(doc(db, 'payments', linkedPayment.id), { status: 'overdue', updatedAt: Timestamp.now() });
                linkedPayment.status = 'overdue';
              }
              updatedCount++;
            } catch (error) {  }
          }
        }
      }
      
      if (updatedCount > 0) {
        showToast('info', 'Status Updated', `${updatedCount} payment(s) marked as overdue`);
        updateSummary();
        renderPayments();
        renderInvoices();
      }
    }

    // ============================================
    // DATE RANGE FUNCTIONS
    // ============================================
    function setDateRange(range) {
      currentDateRange = range;
      const today = new Date();
      
      switch (range) {
        case 'today':
          startDate = new Date(today.setHours(0, 0, 0, 0));
          endDate = new Date(today.setHours(23, 59, 59, 999));
          break;
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          weekStart.setHours(0, 0, 0, 0);
          startDate = weekStart;
          endDate = new Date(weekStart);
          endDate.setDate(weekStart.getDate() + 6);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
          break;
        case 'year':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999);
          break;
        case 'custom':
          document.getElementById('customDateRange').classList.remove('hidden');
          return;
      }
      
      document.getElementById('customDateRange').classList.add('hidden');
      
      // Update active button
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      
      loadData();
    }

    // ============================================
    // LOAD DATA
    // ============================================
    async function loadClients() {
      try {
        const snapshot = await getDocs(collection(db, 'clients'));
        snapshot.forEach(doc => {
          clients[doc.id] = { id: doc.id, ...doc.data() };
        });
        populateClientSelect();
      } catch (error) {

      }
    }

    async function loadTeams() {
      try {
        const snapshot = await getDocs(collection(db, 'teams'));
        teams = [];
        snapshot.forEach(doc => {
          teams.push({ id: doc.id, ...doc.data() });
        });
      } catch (error) {
        console.error('Error loading teams:', error);
      }
    }

    async function loadData() {
      await Promise.all([
        loadPayments(),
        loadExpenses(),
        loadInvoices(),
        loadSchedules(),
        loadCompletedSchedules()
      ]);
      
      updateSummary();
      renderPayments();
      renderExpenses();
      renderInvoices();
      renderCompletedJobs();
    }

    async function loadCompletedSchedules() {
      try {
        const q = query(collection(db, 'schedules'), where('status', '==', 'completed'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);
        completedSchedules = [];
        snapshot.forEach(doc => { completedSchedules.push({ id: doc.id, ...doc.data() }); });
      } catch (error) {  }
    }

    async function loadPayments() {
      try {
        const q = query(collection(db, 'payments'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);

        payments = [];
        snapshot.forEach(doc => {
          const payment = { id: doc.id, ...doc.data() };
          const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date(payment.date);
          if (paymentDate >= startDate && paymentDate <= endDate) {
            payments.push(payment);
          }
        });

        // Link existing unlinked payments to their schedules' invoices
        await linkUnlinkedPaymentsToInvoices();
      } catch (error) {

      }
    }

    // Recovery function: Link existing payments to invoices based on their schedules
    async function linkUnlinkedPaymentsToInvoices() {
      try {
        const allPaymentsSnapshot = await getDocs(collection(db, 'payments'));

        for (const paymentDoc of allPaymentsSnapshot.docs) {
          const payment = paymentDoc.data();

          // Only process payments that don't have linkedInvoiceId and have a scheduleId
          if (!payment.linkedInvoiceId && payment.scheduleId) {
            try {
              // Get the schedule to see if it has an invoiceId
              const scheduleDoc = await getDoc(doc(db, 'schedules', payment.scheduleId));

              if (scheduleDoc.exists()) {
                const schedule = scheduleDoc.data();

                if (schedule.invoiceId) {
                  // Link this payment to the invoice
                  await updateDoc(paymentDoc.ref, {
                    linkedInvoiceId: schedule.invoiceId
                  });
                }
              }
            } catch (error) {
              // Silently handle errors
            }
          }
        }
      } catch (error) {
        // Silently handle errors
      }
    }

    async function loadExpenses() {
      try {
        const q = query(collection(db, 'expenses'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);
        
        expenses = [];
        snapshot.forEach(doc => {
          const expense = { id: doc.id, ...doc.data() };
          const expenseDate = expense.date?.toDate ? expense.date.toDate() : new Date(expense.date);
          if (expenseDate >= startDate && expenseDate <= endDate) {
            expenses.push(expense);
          }
        });
      } catch (error) {
        
      }
    }

    async function loadInvoices() {
      try {
        const q = query(collection(db, 'invoices'), orderBy('invoiceDate', 'desc'));
        const snapshot = await getDocs(q);

        invoices = [];
        snapshot.forEach(doc => {
          invoices.push({ id: doc.id, ...doc.data() });
        });
      } catch (error) {
        console.error('Error loading invoices:', error);
      }
    }

    async function loadSchedules() {
      try {
        // Load ALL schedules (not just completed ones)
        const snapshot = await getDocs(collection(db, 'schedules'));

        schedules = [];
        snapshot.forEach(doc => {
          schedules.push({ id: doc.id, ...doc.data() });
        });
      } catch (error) {
        console.error('Error loading schedules:', error);
      }
    }

    async function loadCompanySettings() {
      try {
        const companyDoc = await getDoc(doc(db, 'config', 'companyInfo'));
        const emailDoc = await getDoc(doc(db, 'config', 'invoiceEmailTemplate'));

        if (companyDoc.exists()) {
          companyInfo = companyDoc.data();
        } else {
          // Defaults
          companyInfo = {
            name: 'Mendez Cleaning',
            tagline: 'Professional Cleaning Services',
            phone: '(555) 123-4567',
            email: '',
            address: 'Your Business Address',
            city: 'City',
            state: 'State',
            zip: 'ZIP',
            taxEnabled: false,
            taxPercentage: 5.00
          };
        }

        if (emailDoc.exists()) {
          invoiceEmailTemplate = emailDoc.data();
        } else {
          // Defaults
          invoiceEmailTemplate = {
            subject: 'Invoice {invoiceNumber} from {companyName}',
            message: 'Please find attached your invoice. Payment is due within 7 days.'
          };
        }

        // Populate form fields
        document.getElementById('settingsCompanyName').value = companyInfo.name || '';
        document.getElementById('settingsTagline').value = companyInfo.tagline || '';
        document.getElementById('settingsPhone').value = companyInfo.phone || '';
        document.getElementById('settingsEmail').value = companyInfo.email || '';
        document.getElementById('settingsAddress').value = companyInfo.address || '';
        document.getElementById('settingsCity').value = companyInfo.city || '';
        document.getElementById('settingsState').value = companyInfo.state || '';
        document.getElementById('settingsZip').value = companyInfo.zip || '';
        document.getElementById('settingsEmailSubject').value = invoiceEmailTemplate.subject || '';
        document.getElementById('settingsEmailMessage').value = invoiceEmailTemplate.message || '';
        document.getElementById('settingsTaxEnabled').checked = companyInfo.taxEnabled || false;
        document.getElementById('settingsTaxPercentage').value = companyInfo.taxPercentage || 5.00;
      } catch (error) {

      }
    }

    // ============================================
    // UPDATE SUMMARY
    // ============================================
    function updateSummary() {
      // Calculate revenue from payments
      const totalRevenue = payments
        .filter(p => p.status === 'paid')
        .reduce((sum, p) => sum + (p.amount || 0), 0);
      
      // Calculate expenses
      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      
      // Net profit
      const netProfit = totalRevenue - totalExpenses;
      
      // Pending payments
      const pendingPayments = payments
        .filter(p => p.status === 'pending' || p.status === 'overdue')
        .reduce((sum, p) => sum + (p.amount || 0), 0);
      
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
      document.getElementById('netProfit').textContent = formatCurrency(netProfit);
      document.getElementById('pendingPayments').textContent = formatCurrency(pendingPayments);
    }
    // ============================================
    // PAYMENT STATUS FUNCTIONS
    // ============================================
    window.updatePaymentStatus = async function(id, newStatus) {
      try {
        await updateDoc(doc(db, 'payments', id), { 
          status: newStatus, 
          updatedAt: Timestamp.now(), 
          ...(newStatus === 'paid' ? { paidAt: Timestamp.now() } : {}) 
        });
        const payment = payments.find(p => p.id === id);
        if (payment?.invoiceId && newStatus === 'paid') {
          await updateDoc(doc(db, 'invoices', payment.invoiceId), { status: 'paid', updatedAt: Timestamp.now() });
        }
        await logPaymentAction(AuditActions.UPDATE, id, `Status changed to ${newStatus}`);
        showToast('success', 'Success', `Payment status updated to ${newStatus}`);
        await loadPayments();
        await loadInvoices();
        updateSummary();
        renderPayments();
        renderInvoices();
        renderCompletedJobs();
      } catch (error) { 
         
        showToast('error', 'Error', 'Failed to update'); 
      }
    };

    window.updateJobPaymentStatus = async function(scheduleId, paymentId, newStatus) {
      try {
        if (paymentId) {
          await updateDoc(doc(db, 'payments', paymentId), { 
            status: newStatus, 
            updatedAt: Timestamp.now(), 
            ...(newStatus === 'paid' ? { paidAt: Timestamp.now() } : {}) 
          });
        } else {
          const schedule = completedSchedules.find(s => s.id === scheduleId);
          if (schedule) {
            await addDoc(collection(db, 'payments'), { 
              scheduleId, 
              clientId: schedule.clientId, 
              date: Timestamp.now(), 
              amount: schedule.serviceDetails?.totalPrice || 0, 
              status: newStatus, 
              createdAt: Timestamp.now() 
            });
          }
        }
        showToast('success', 'Success', `Payment status updated to ${newStatus}`);
        await loadPayments();
        updateSummary();
        renderPayments();
        renderCompletedJobs();
      } catch (error) { 
         
        showToast('error', 'Error', 'Failed to update'); 
      }
    };

    window.markJobAsPaid = async function(scheduleId, paymentId) { 
      await updateJobPaymentStatus(scheduleId, paymentId, 'paid'); 
    };

    // ============================================
    // INVOICE STATUS FUNCTIONS
    // ============================================

    window.updateInvoiceStatus = async function(id, newStatus) {
      try {
        await updateDoc(doc(db, 'invoices', id), { status: newStatus, updatedAt: Timestamp.now() });
        if (newStatus === 'paid') {
          const linkedPayment = payments.find(p => p.invoiceId === id);
          if (linkedPayment) {
            await updateDoc(doc(db, 'payments', linkedPayment.id), { status: 'paid', paidAt: Timestamp.now(), updatedAt: Timestamp.now() });
          }
        }
        showToast('success', 'Success', `Invoice status updated to ${newStatus}`);
        await loadInvoices();
        await loadPayments();
        updateSummary();
        renderInvoices();
        renderPayments();
      } catch (error) { 
         
        showToast('error', 'Error', 'Failed to update'); 
      }
    };

    // ============================================
    // SEND INVOICE FUNCTIONS
    // ============================================

    window.sendInvoice = function(id) {
      currentInvoiceId = id;
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) return;
      const client = clients[invoice.clientId] || {};
      const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);

      // Use template with placeholders for subject
      let subject = invoiceEmailTemplate?.subject || 'Invoice {invoiceNumber} from {companyName}';
      subject = subject
        .replace('{invoiceNumber}', invoice.invoiceNumber)
        .replace('{companyName}', companyInfo?.name || 'Mendez Cleaning');

      // Use template with placeholders for message
      let messageTemplate = invoiceEmailTemplate?.message || 'Please find attached your invoice. Payment is due within 7 days.';
      messageTemplate = messageTemplate
        .replace('{invoiceNumber}', invoice.invoiceNumber)
        .replace('{amount}', formatCurrency(invoice.total || 0))
        .replace('{dueDate}', formatDate(dueDate, { month: 'long', day: 'numeric', year: 'numeric' }));

      document.getElementById('sendInvoiceEmail').value = client.email || '';
      document.getElementById('sendInvoiceSubject').value = subject;
      document.getElementById('sendInvoiceMessage').value = messageTemplate;
      openModal('sendInvoiceModal');
    };

    async function confirmSendInvoice() {
      const email = document.getElementById('sendInvoiceEmail').value;
      const subject = document.getElementById('sendInvoiceSubject').value;
      const message = document.getElementById('sendInvoiceMessage').value;
      
      if (!email) {
        showToast('error', 'Error', 'Please enter an email address');
        return;
      }
      
      const invoice = invoices.find(i => i.id === currentInvoiceId);
      if (!invoice) {
        showToast('error', 'Error', 'Invoice not found');
        return;
      }
      
      const client = clients[invoice.clientId] || {};
      const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);
      
      // Show loading state
      const sendBtn = document.getElementById('confirmSendInvoiceBtn');
      const originalText = sendBtn.innerHTML;
      sendBtn.innerHTML = '‚è≥ Preparing...';
      sendBtn.disabled = true;
      
      try {
        // Generate PDF

        // Update invoice status FIRST
        await updateDoc(doc(db, 'invoices', currentInvoiceId), {
          status: 'sent',
          sentAt: Timestamp.now(),
          sentTo: email,
          updatedAt: Timestamp.now()
        });

        // Update local invoice object so PDF shows correct status
         invoice.status = 'sent';

        const pdfDoc = await generateInvoicePDF(invoice, client);
        const pdfBlob = pdfDoc.output('blob');
        const fileName = `Invoice-${invoice.invoiceNumber}.pdf`;
        
        // Try Web Share API (works great on mobile)
        if (navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], fileName, { type: 'application/pdf' })] })) {
          const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
          
          await navigator.share({
            title: subject,
            text: message,
            files: [file]
          });
          
          showToast('success', 'Success', 'Invoice shared successfully');
        } else {
          // Fallback: Download PDF + Open mailto
          pdfDoc.save(fileName);          
          const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message + '\n\n---\nPlease find the invoice PDF attached.\nInvoice #: ' + invoice.invoiceNumber + '\nAmount: ' + formatCurrency(invoice.total || 0) + '\nDue Date: ' + formatDate(dueDate, { month: 'long', day: 'numeric', year: 'numeric' }))}`;
          
          window.open(mailtoLink, '_blank');
          
          showToast('info', 'PDF Downloaded', 'Please attach the downloaded PDF to your email');
        }
        
        // Update invoice status to sent
        await updateDoc(doc(db, 'invoices', currentInvoiceId), {
          status: 'sent',
          sentAt: Timestamp.now(),
          sentTo: email,
          updatedAt: Timestamp.now()
        });
        
        closeModal('sendInvoiceModal');
        await loadInvoices();
        renderInvoices();
        
      } catch (error) {
        // User cancelled share or error occurred
        if (error.name !== 'AbortError') {
          
          showToast('error', 'Error', 'Failed to send invoice');
        }
      } finally {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
      }
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================

    function renderCompletedJobs() {
      const tbody = document.getElementById('completedJobsBody');
      const emptyState = document.getElementById('noCompletedJobs');
      const table = document.getElementById('completedJobsTable');
      const filter = document.getElementById('completedJobsFilter')?.value || '';
      
      let jobsWithPaymentStatus = completedSchedules.map(schedule => {
        const payment = payments.find(p => p.scheduleId === schedule.id);
        return { ...schedule, paymentStatus: payment?.status || 'pending', paymentId: payment?.id };
      });
      
      if (filter) jobsWithPaymentStatus = jobsWithPaymentStatus.filter(j => j.paymentStatus === filter);
      
      if (jobsWithPaymentStatus.length === 0) { 
        table.classList.add('hidden'); 
        emptyState.classList.remove('hidden'); 
        return; 
      }
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      tbody.innerHTML = jobsWithPaymentStatus.map(job => {
        const client = clients[job.clientId] || {};
        const completedDate = job.actualEndTime?.toDate ? job.actualEndTime.toDate() : (job.date ? new Date(job.date) : new Date());

        // ‚úÖ NEW: Check if job schedule has a linked invoice
        const linkedInvoice = job.invoiceId ? invoices.find(inv => inv.id === job.invoiceId) : null;
        const invoiceIndicator = linkedInvoice ? `
          <div style="display: inline-flex; align-items: center; gap: 4px; background: var(--info-100); color: var(--info-700); padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-top: 2px;">
            üìã ${linkedInvoice.invoiceNumber} - ${linkedInvoice.status}
          </div>
        ` : '';

        return `<tr>
          <td>${formatDate(completedDate, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          <td>
            <div class="font-semibold">${client.firstName || ''} ${client.lastName || 'Unknown'}</div>
            ${invoiceIndicator}
          </td>
          <td><div class="text-sm">${client.address?.street || ''}</div><div class="text-xs text-gray-500">${client.address?.city || ''}</div></td>
          <td>${getServiceSummary(clients[job.clientId])}</td>
          <td class="font-semibold">${formatCurrency(job.serviceDetails?.totalPrice || 0)}</td>
          <td>
            <select class="status-select ${job.paymentStatus}" onchange="updateJobPaymentStatus('${job.id}', '${job.paymentId || ''}', this.value)">
              <option value="pending" ${job.paymentStatus === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="paid" ${job.paymentStatus === 'paid' ? 'selected' : ''}>Paid</option>
              <option value="overdue" ${job.paymentStatus === 'overdue' ? 'selected' : ''}>Overdue</option>
            </select>
          </td>
          <td>${job.paymentStatus !== 'paid' ? `<button class="btn btn-success btn-sm" onclick="markJobAsPaid('${job.id}', '${job.paymentId || ''}')">Mark Paid</button>` : ''}</td>
        </tr>`;
      }).join('');
    }

    function renderPayments() {
      const tbody = document.getElementById('paymentsBody');
      const emptyState = document.getElementById('noPayments');
      const table = document.getElementById('paymentsTable');
      
      const filter = document.getElementById('paymentStatusFilter').value;
      let filtered = payments;
      if (filter) {
        filtered = payments.filter(p => p.status === filter);
      }
      
      if (filtered.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      const methodIcons = {
        cash: 'üíµ',
        check: 'üìù',
        card: 'üí≥',
        venmo: 'üì±',
        zelle: 'üì≤'
      };
      
      const statusClasses = {
        paid: 'completed',
        pending: 'pending',
        overdue: 'cancelled'
      };
      
      tbody.innerHTML = filtered.map(payment => {
        const client = clients[payment.clientId];
        const schedule = schedules.find(s => s.id === payment.scheduleId);
        const date = payment.date?.toDate ? payment.date.toDate() : new Date(payment.date);

        // ‚úÖ NEW: Check if payment is linked to an invoice
        const linkedInvoice = invoices.find(inv => inv.id === (payment.linkedInvoiceId || payment.invoiceId));
        const invoiceIndicator = linkedInvoice ? `
          <div style="display: inline-flex; align-items: center; gap: 4px; background: var(--info-100); color: var(--info-700); padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-top: 2px;">
            üìã ${linkedInvoice.invoiceNumber}
          </div>
        ` : '';

        return `
          <tr>
            <td>${formatDate(date, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td>
              <div class="font-semibold">${client?.firstName || ''} ${client?.lastName || 'Unknown'}</div>
              ${invoiceIndicator}
            </td>
            <td>${getServiceSummary(clients[payment.clientId])}</td>
            <td>
              <span>${methodIcons[payment.paymentMethod] || ''} ${payment.paymentMethod || '-'}</span>
            </td>
            <td class="font-semibold">${formatCurrency(payment.amount || 0)}</td>
            <td>
              <span class="status-badge ${statusClasses[payment.status] || 'pending'}">
                ${payment.status || 'pending'}
              </span>
            </td>
            <td>
              ${payment.status !== 'paid' ? `
                <button class="btn btn-success btn-sm" onclick="markAsPaid('${payment.id}')">
                  Mark Paid
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderExpenses() {
      const tbody = document.getElementById('expensesBody');
      const emptyState = document.getElementById('noExpenses');
      const table = document.getElementById('expensesTable');
      
      const filter = document.getElementById('expenseCategoryFilter').value;
      let filtered = expenses;
      if (filter) {
        filtered = expenses.filter(e => e.category === filter);
      }
      
      if (filtered.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      const categoryIcons = {
        supplies: 'üß¥',
        equipment: 'üîß',
        vehicle: 'üöó',
        insurance: 'üõ°Ô∏è',
        payroll: 'üíµ',
        marketing: 'üì¢',
        office: 'üè¢',
        other: 'üì¶'
      };
      
      tbody.innerHTML = filtered.map(expense => {
        const date = expense.date?.toDate ? expense.date.toDate() : new Date(expense.date);
        
        return `
          <tr>
            <td>${formatDate(date, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td>
              <div class="flex items-center gap-2">
                <div class="expense-category-icon ${expense.category}">
                  ${categoryIcons[expense.category] || 'üì¶'}
                </div>
                <span class="capitalize">${expense.category}</span>
              </div>
            </td>
            <td>${expense.description || '-'}</td>
            <td>${expense.vendor || '-'}</td>
            <td class="font-semibold text-danger">${formatCurrency(expense.amount || 0)}</td>
            <td>
              <div class="table-actions">
                <button class="btn btn-ghost btn-icon btn-sm" onclick="editExpense('${expense.id}')" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteExpense('${expense.id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderInvoices() {
      const tbody = document.getElementById('invoicesBody');
      const emptyState = document.getElementById('noInvoices');
      const table = document.getElementById('invoicesTable');
      
      const filter = document.getElementById('invoiceStatusFilter').value;
      let filtered = invoices;
      if (filter) {
        filtered = invoices.filter(i => i.status === filter);
      }
      
      if (filtered.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      const statusClasses = {
        draft: 'pending',
        sent: 'active',
        paid: 'completed',
        overdue: 'cancelled'
      };
      
      tbody.innerHTML = filtered.map(invoice => {
        const client = clients[invoice.clientId];
        const invoiceDate = invoice.invoiceDate?.toDate ? invoice.invoiceDate.toDate() : new Date(invoice.invoiceDate);
        const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);
        
        return `
          <tr>
            <td class="font-semibold">${invoice.invoiceNumber || '-'}</td>
            <td>${client?.firstName || ''} ${client?.lastName || 'Unknown'}</td>
            <td>${formatDate(invoiceDate, { month: 'short', day: 'numeric' })}</td>
            <td>${formatDate(dueDate, { month: 'short', day: 'numeric' })}</td>
            <td class="font-semibold">${formatCurrency(invoice.total || 0)}</td>
            <td>
              <span class="status-badge ${statusClasses[invoice.status] || 'pending'}">
                ${invoice.status || 'draft'}
              </span>
            </td>
            <td>
              <div class="table-actions">
                <button class="btn btn-ghost btn-icon btn-sm" onclick="viewInvoice('${invoice.id}')" title="View">üëÅÔ∏è</button>
                <button class="btn btn-ghost btn-icon btn-sm" onclick="editInvoice('${invoice.id}')" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-ghost btn-icon btn-sm" onclick="printInvoiceById('${invoice.id}')" title="Print">üñ®Ô∏è</button>
                <button class="btn btn-ghost btn-icon btn-sm" onclick="sendInvoice('${invoice.id}')" title="Send">üìß</button>
                <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteInvoice('${invoice.id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ============================================
    // EXPENSE CRUD
    // ============================================
    function openExpenseModal() {
      editingExpenseId = null;
      document.getElementById('expenseModalTitle').textContent = i18n.t('addExpense');
      document.getElementById('expenseForm').reset();
      const today = new Date();
      document.getElementById('expenseDate').value = toLocalDateString(new Date());
      document.getElementById('recurringOptions').classList.add('hidden');
      openModal('expenseModal');
    }

    window.editExpense = function(id) {
      const expense = expenses.find(e => e.id === id);
      if (!expense) return;
      
      editingExpenseId = id;
      document.getElementById('expenseModalTitle').textContent = i18n.t('editExpense');
      
      const date = expense.date?.toDate ? expense.date.toDate() : new Date(expense.date);
      document.getElementById('expenseDate').value = toLocalDateString(date);
      document.getElementById('expenseCategory').value = expense.category || '';
      document.getElementById('expenseDescription').value = expense.description || '';
      document.getElementById('expenseAmount').value = expense.amount || '';
      document.getElementById('expenseVendor').value = expense.vendor || '';
      document.getElementById('expenseRecurring').checked = expense.isRecurring || false;
      document.getElementById('expenseNotes').value = expense.notes || '';
      
      if (expense.isRecurring) {
        document.getElementById('recurringOptions').classList.remove('hidden');
        document.getElementById('expenseFrequency').value = expense.frequency || 'monthly';
      }
      
      openModal('expenseModal');
    };

    async function saveExpense() {
      const dateStr = document.getElementById('expenseDate').value;
      const [year, month, day] = dateStr.split('-').map(Number);
      const date = new Date(year, month - 1, day, 12, 0, 0);      
      const category = document.getElementById('expenseCategory').value;
      
      const description = document.getElementById('expenseDescription').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      
      if (!date || !category || !description || isNaN(amount)) {
        showToast('error', i18n.t('error'), i18n.t('required'));
        return;
      }
      
      const expenseData = {
        date: Timestamp.fromDate(new Date(date)),
        category,
        description,
        amount,
        vendor: document.getElementById('expenseVendor').value.trim(),
        isRecurring: document.getElementById('expenseRecurring').checked,
        frequency: document.getElementById('expenseRecurring').checked ? 
          document.getElementById('expenseFrequency').value : null,
        notes: document.getElementById('expenseNotes').value.trim(),
        updatedAt: Timestamp.now()
      };
      
      try {
        if (editingExpenseId) {
          await updateDoc(doc(db, 'expenses', editingExpenseId), expenseData);
          await logExpenseAction(AuditActions.UPDATE, editingExpenseId, description);
          showToast('success', i18n.t('success'), 'Expense updated');
        } else {
          expenseData.createdBy = currentAdmin.id;
          expenseData.createdAt = Timestamp.now();
          const docRef = await addDoc(collection(db, 'expenses'), expenseData);
          await logExpenseAction(AuditActions.CREATE, docRef.id, description);
          showToast('success', i18n.t('success'), 'Expense added');
        }
        
        closeModal('expenseModal');
        await loadExpenses();
        updateSummary();
        renderExpenses();
      } catch (error) {
        
        showToast('error', i18n.t('error'), 'Failed to save expense');
      }
    }

    window.deleteExpense = async function(id) {
      const expense = expenses.find(e => e.id === id);
      if (!expense) return;
      
      const confirmed = await confirmDialog(
        i18n.t('delete'),
        'Are you sure you want to delete this expense?',
        i18n.t('delete'),
        i18n.t('cancel')
      );
      
      if (!confirmed) return;
      
      try {
        await deleteDoc(doc(db, 'expenses', id));
        await logExpenseAction(AuditActions.DELETE, id, expense.description);
        showToast('success', i18n.t('success'), 'Expense deleted');
        await loadExpenses();
        updateSummary();
        renderExpenses();
      } catch (error) {
        
        showToast('error', i18n.t('error'), 'Failed to delete expense');
      }
    };

    // ============================================
    // PAYMENT FUNCTIONS
    // ============================================
    window.toggleCustomPaymentMethod = function() {
      const method = document.getElementById('recordPaymentMethod').value;
      const customGroup = document.getElementById('customPaymentMethodGroup');
      if (method === 'other') {
        customGroup.classList.remove('hidden');
      } else {
        customGroup.classList.add('hidden');
      }
    };

    window.markAsPaid = async function(id) {
      editingPaymentId = id;
      const payment = payments.find(p => p.id === id);
      if (!payment) return;

      document.getElementById('recordPaymentAmount').value = payment.amount || '';

      // Check if payment method is custom (not in the standard list)
      const standardMethods = ['cash', 'check', 'card', 'venmo', 'zelle'];
      const isCustomMethod = payment.paymentMethod && !standardMethods.includes(payment.paymentMethod);

      if (isCustomMethod) {
        document.getElementById('recordPaymentMethod').value = 'other';
        document.getElementById('customPaymentMethod').value = payment.paymentMethod || '';
      } else {
        document.getElementById('recordPaymentMethod').value = payment.paymentMethod || 'cash';
        document.getElementById('customPaymentMethod').value = '';
      }

      document.getElementById('recordPaymentNotes').value = '';
      toggleCustomPaymentMethod();

      openModal('paymentModal');
    };

    async function savePayment() {
      if (!editingPaymentId) return;

      try {
        // Get the payment to check if it's linked to an invoice
        const payment = payments.find(p => p.id === editingPaymentId);

        // If custom payment method is selected, use the custom text input value
        let paymentMethod = document.getElementById('recordPaymentMethod').value;
        if (paymentMethod === 'other') {
          paymentMethod = document.getElementById('customPaymentMethod').value || 'Other';
        }

        await updateDoc(doc(db, 'payments', editingPaymentId), {
          status: 'paid',
          paymentMethod: paymentMethod,
          amount: parseFloat(document.getElementById('recordPaymentAmount').value),
          paidAt: Timestamp.now(),
          notes: document.getElementById('recordPaymentNotes').value
        });

        // If this payment is linked to an invoice, automatically mark the invoice as paid
        if (payment?.linkedInvoiceId) {
          await updateDoc(doc(db, 'invoices', payment.linkedInvoiceId), {
            status: 'paid',
            updatedAt: Timestamp.now()
          });
        }

        // Also handle old invoiceId field for backward compatibility
        if (payment?.invoiceId) {
          await updateDoc(doc(db, 'invoices', payment.invoiceId), {
            status: 'paid',
            updatedAt: Timestamp.now()
          });
        }

        await logPaymentAction(AuditActions.UPDATE, editingPaymentId, 'Marked as paid');
        showToast('success', i18n.t('success'), 'Payment recorded');

        closeModal('paymentModal');

        // Reload ALL data so everything updates
        await loadPayments();
        await loadInvoices();
        await loadSchedules();  // Also reload schedules for completed jobs
        updateSummary();

        // Render everything
        renderPayments();

        // Reset invoice filter to show all invoices (so user can see the updated paid invoice)
        const invoiceFilter = document.getElementById('invoiceStatusFilter');
        if (invoiceFilter) {
          invoiceFilter.value = '';  // Clear the filter
        }

        renderInvoices();
        renderCompletedJobs();  // Also update completed jobs
      } catch (error) {
        console.error('Error saving payment:', error);
        showToast('error', i18n.t('error'), 'Failed to record payment');
      }
    }

    // ============================================
    // INVOICE FUNCTIONS
    // ============================================
    let editingInvoiceId = null;

    function openInvoiceModal() {
      editingInvoiceId = null;
      document.getElementById('invoiceForm').reset();
      invoiceItems = [{ description: 'Cleaning Service', quantity: 1, rate: 0 }];
      renderInvoiceItems();

      // Generate invoice number
      const invoiceNum = 'INV-' + Date.now().toString().slice(-6);
      document.getElementById('invoiceNumber').value = invoiceNum;

      // Set dates
      const today = new Date();
      document.getElementById('invoiceDate').value = toLocalDateString(today);
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 7);
      document.getElementById('invoiceDueDate').value = toLocalDateString(dueDate);

      // Set tax defaults from company settings
      document.getElementById('invoiceTaxEnabled').checked = companyInfo.taxEnabled || false;
      document.getElementById('invoiceTaxPercentage').value = companyInfo.taxPercentage || 5.00;

      openModal('invoiceModal');
    }

    window.editInvoice = function(invoiceId) {
      const invoice = invoices.find(i => i.id === invoiceId);
      if (!invoice) return;

      editingInvoiceId = invoiceId;
      document.getElementById('invoiceForm').reset();

      // Populate form with invoice data
      const invoiceDate = invoice.invoiceDate?.toDate ? invoice.invoiceDate.toDate() : new Date(invoice.invoiceDate);
      const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);

      document.getElementById('invoiceClient').value = invoice.clientId;
      document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
      document.getElementById('invoiceDate').value = toLocalDateString(invoiceDate);
      document.getElementById('invoiceDueDate').value = toLocalDateString(dueDate);
      document.getElementById('invoiceTaxEnabled').checked = invoice.taxEnabled || false;
      document.getElementById('invoiceTaxPercentage').value = invoice.taxPercentage || 5.00;
      document.getElementById('invoiceNotes').value = invoice.notes || '';

      // Load invoice items
      invoiceItems = (invoice.items || []).map(item => ({...item}));
      renderInvoiceItems();
      updateInvoiceTotals();

      openModal('invoiceModal');
    };

    function populateClientSelect() {
      const select = document.getElementById('invoiceClient');
      const clientsWithInvoice = Object.values(clients).filter(c => c.requiresInvoice && c.isActive);
      
      select.innerHTML = '<option value="">-- Select Client --</option>' +
        clientsWithInvoice.map(c => 
          `<option value="${c.id}" data-price="${c.basePrice || 0}">${c.lastName}, ${c.firstName}</option>`
        ).join('');
      
      if (clientsWithInvoice.length === 0) {
        select.innerHTML += '<option disabled>No clients require invoices</option>';
      }
    }

    function renderInvoiceItems() {
      const tbody = document.getElementById('invoiceItemsBody');

      tbody.innerHTML = invoiceItems.map((item, index) => `
        <tr>
          <td>
            <input type="text" class="form-input" value="${item.description}"
                   onchange="updateInvoiceItem(${index}, 'description', this.value)">
          </td>
          <td style="width: 180px;">
            <div style="display: flex; align-items: center; gap: 4px;">
              <span style="padding: 0 8px;">$</span>
              <input type="number" class="form-input" value="${item.rate}" step="0.01"
                     onchange="updateInvoiceItem(${index}, 'rate', this.value)"
                     oninput="updateInvoiceItemLive(${index}, 'rate', this.value)"
                     style="flex: 1; min-width: 140px;">
            </div>
          </td>
          <td class="font-semibold amount-${index}">${formatCurrency(item.rate)}</td>
          <td>
            ${invoiceItems.length > 1 ? `
              <button type="button" class="btn btn-ghost btn-icon btn-sm" onclick="removeInvoiceItem(${index})">üóëÔ∏è</button>
            ` : ''}
          </td>
        </tr>
      `).join('');

      updateInvoiceTotals();
    }

    window.updateInvoiceItem = function(index, field, value) {
      if (field === 'rate') {
        invoiceItems[index].rate = parseFloat(value) || 0;
        // Ensure qty is always 1
        invoiceItems[index].quantity = 1;
      } else {
        invoiceItems[index][field] = value;
      }
      updateInvoiceTotals();
    };

    window.updateInvoiceItemLive = function(index, field, value) {
      const rate = parseFloat(value) || 0;
      const amountCell = document.querySelector(`.amount-${index}`);
      if (amountCell) {
        amountCell.textContent = formatCurrency(rate);
      }
      // Update totals in real-time as well
      updateInvoiceTotalsLive(rate, index);
    };

    function updateInvoiceTotalsLive(newRate, index) {
      const subtotal = invoiceItems.reduce((sum, item, i) => {
        return sum + (item.quantity * (i === index ? newRate : item.rate));
      }, 0);

      const taxEnabled = document.getElementById('invoiceTaxEnabled').checked;
      const taxPercentage = parseFloat(document.getElementById('invoiceTaxPercentage').value) || 0;
      const tax = taxEnabled ? (subtotal * taxPercentage / 100) : 0;
      const total = subtotal + tax;

      const subtotalEl = document.getElementById('invoiceSubtotal');
      const taxEl = document.getElementById('invoiceTax');
      const totalEl = document.getElementById('invoiceTotal');

      if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
      if (taxEl) taxEl.textContent = formatCurrency(tax);
      if (totalEl) totalEl.textContent = formatCurrency(total);
    };

    window.removeInvoiceItem = function(index) {
      invoiceItems.splice(index, 1);
      renderInvoiceItems();
    };

    function addInvoiceItem() {
      invoiceItems.push({ description: '', quantity: 1, rate: 0 });
      renderInvoiceItems();
    }

    function updateInvoiceTotals() {
      const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.rate), 0);

      // Get tax settings from form
      const taxEnabled = document.getElementById('invoiceTaxEnabled').checked;
      const taxPercentage = parseFloat(document.getElementById('invoiceTaxPercentage').value) || 0;

      const tax = taxEnabled ? (subtotal * taxPercentage / 100) : 0;
      const total = subtotal + tax;

      // Update tax label to show the percentage
      const taxLabel = taxEnabled ? `Tax (${taxPercentage.toFixed(2)}%)` : 'Tax (0%)';
      document.querySelector('.flex.justify-between p-2:nth-child(2) span:first-child')?.textContent || updateTaxLabel(taxLabel);

      document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
      document.getElementById('invoiceTax').textContent = formatCurrency(tax);
      document.getElementById('invoiceTotal').textContent = formatCurrency(total);
    }

    function updateTaxLabel(label) {
      // Find and update the tax label in the DOM
      const taxElements = document.querySelectorAll('.flex.justify-between');
      for (let el of taxElements) {
        const span = el.querySelector('span');
        if (span && span.textContent.includes('Tax')) {
          span.textContent = label;
          break;
        }
      }
    }

    function onClientSelect() {
      const select = document.getElementById('invoiceClient');
      const option = select.options[select.selectedIndex];
      
      if (option && option.dataset.price) {
        invoiceItems[0].rate = parseFloat(option.dataset.price) || 0;
        renderInvoiceItems();
      }
    }

    let pendingInvoiceData = null;

    async function saveInvoice() {
      const clientId = document.getElementById('invoiceClient').value;

      if (!clientId) {
        showToast('error', i18n.t('error'), 'Please select a client');
        return;
      }

      const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.rate), 0);

      // Calculate tax
      const taxEnabled = document.getElementById('invoiceTaxEnabled').checked;
      const taxPercentage = parseFloat(document.getElementById('invoiceTaxPercentage').value) || 0;
      const tax = taxEnabled ? (subtotal * taxPercentage / 100) : 0;
      const total = subtotal + tax;

      // Fix date parsing to avoid timezone issues
      const invoiceDateStr = document.getElementById('invoiceDate').value;
      const dueDateStr = document.getElementById('invoiceDueDate').value;
      const [iYear, iMonth, iDay] = invoiceDateStr.split('-').map(Number);
      const [dYear, dMonth, dDay] = dueDateStr.split('-').map(Number);
      const invoiceDate = new Date(iYear, iMonth - 1, iDay, 12, 0, 0);
      const dueDate = new Date(dYear, dMonth - 1, dDay, 12, 0, 0);

      const invoiceData = {
        clientId,
        invoiceNumber: document.getElementById('invoiceNumber').value,
        invoiceDate: Timestamp.fromDate(invoiceDate),
        dueDate: Timestamp.fromDate(dueDate),
        items: invoiceItems,
        subtotal,
        taxEnabled,
        taxPercentage,
        tax,
        total,
        notes: document.getElementById('invoiceNotes').value,
        updatedAt: Timestamp.now(),
        updatedBy: currentAdmin.id
      };

      try {
        if (editingInvoiceId) {
          // Update existing invoice (don't change status)
          await updateDoc(doc(db, 'invoices', editingInvoiceId), invoiceData);
          editingInvoiceId = null;
          showToast('success', i18n.t('success'), 'Invoice updated');
          closeModal('invoiceModal');
          await loadInvoices();
          await loadPayments();
          updateSummary();
          renderInvoices();
          renderPayments();
        } else {
          // Check if client has a scheduled job today BEFORE creating invoice
          const todayStr = toLocalDateString(new Date());

          try {
            const schedulesSnap = await getDocs(
              query(
                collection(db, 'schedules'),
                where('clientId', '==', clientId),
                where('date', '==', todayStr),
                where('status', '!=', 'completed')
              )
            );

            if (!schedulesSnap.empty) {
              // Found schedule(s) - create invoice and automatically link to first schedule
              invoiceData.status = 'draft';
              invoiceData.createdAt = Timestamp.now();
              invoiceData.createdBy = currentAdmin.id;

              const docRef = await addDoc(collection(db, 'invoices'), invoiceData);

              // Link to first schedule
              const firstSchedule = schedulesSnap.docs[0];
              await updateDoc(doc(db, 'schedules', firstSchedule.id), {
                invoiceId: docRef.id
              });

              showToast('success', i18n.t('success'), 'Invoice created and linked to schedule');
              closeModal('invoiceModal');
              await loadInvoices();
              await loadPayments();
              updateSummary();
              renderInvoices();
              renderPayments();
            } else {
              // No schedule found - store invoice data and show modal to add schedule first
              pendingInvoiceData = {
                invoiceData,
                invoiceDate
              };
              closeModal('invoiceModal');
              showQuickAddScheduleModal(clientId, null, invoiceDate);
            }
          } catch (error) {
            console.error('Error checking for schedules:', error);
            showToast('error', i18n.t('error'), 'Error checking schedule');
          }
        }
      } catch (error) {
        console.error('Error saving invoice:', error);
        showToast('error', i18n.t('error'), 'Failed to save invoice');
      }
    }

    // ============================================
    // QUICK ADD SCHEDULE (from invoice creation)
    // ============================================
    let pendingScheduleData = {};

    function calculateNextRouteOrderForTeam(teamId) {
      if (!teamId) return 1;

      const todayStr = toLocalDateString(new Date());

      // Filter by date AND teamId
      const teamSchedulesToday = schedules.filter(s => s.date === todayStr && s.teamId === teamId);

      const routeOrders = teamSchedulesToday.map(s => s.routeOrder || 0);
      const maxRouteOrder = routeOrders.length > 0 ? Math.max(...routeOrders) : 0;
      const nextRouteOrder = maxRouteOrder + 1;

      return nextRouteOrder;
    }

    function updateRouteOrderDisplay() {
      const teamId = document.getElementById('teamSelect')?.value;
      const routeOrderDisplay = document.getElementById('routeOrderDisplay');

      if (!routeOrderDisplay) return;

      if (!teamId) {
        routeOrderDisplay.innerHTML = `
          <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Route Order (Auto-assigned)</div>
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-500);">Select a team first</div>
        `;
        document.getElementById('routeOrder').value = '';
      } else {
        const nextRoute = calculateNextRouteOrderForTeam(teamId);
        routeOrderDisplay.innerHTML = `
          <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Route Order (Auto-assigned)</div>
          <div style="font-size: 20px; font-weight: 700; color: var(--primary-600);">#${nextRoute}</div>
          <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">Will be added as #${nextRoute} in today's route</div>
        `;
        document.getElementById('routeOrder').value = nextRoute;
      }
    }

    function showQuickAddScheduleModal(clientId, invoiceId, invoiceDate) {
      const client = clients[clientId] || {};

      // Store data for the button handler
      pendingScheduleData = { clientId, invoiceId, invoiceDate };

      const modalContent = `
        <p style="margin: 0 0 16px 0; color: var(--gray-700);">
          <strong>${client.firstName} ${client.lastName}</strong> is not scheduled for today.
          <br>Would you like to add them now?
        </p>

        <div style="background: var(--info-50); border: 1px solid var(--info-300); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--info-700); font-weight: 600;">‚ÑπÔ∏è Quick Add</div>
          <div style="font-size: 13px; color: var(--info-800); margin-top: 4px;">
            Add client to today's schedule and automatically link this invoice.
          </div>
        </div>

        <div style="margin-bottom: 16px; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px;" id="routeOrderDisplay">
          <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Route Order (Auto-assigned)</div>
          <div style="font-size: 16px; font-weight: 700; color: var(--gray-500);">Select a team first</div>
        </div>
        <input type="hidden" id="routeOrder" value="">

        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-900);">Team Assignment</label>
          <select id="teamSelect" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; background: white;">
            <option value="">-- Select Team --</option>
            ${teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('') || '<option disabled>No teams available</option>'}
          </select>
        </div>
      `;

      // Populate modal body
      document.getElementById('quickAddScheduleBody').innerHTML = modalContent;

      // Add event listener to team select for dynamic route order calculation
      setTimeout(() => {
        const teamSelect = document.getElementById('teamSelect');
        if (teamSelect) {
          teamSelect.addEventListener('change', updateRouteOrderDisplay);
        }
      }, 0);

      openModal('quickAddScheduleModal');
    }

    window.quickCreateScheduleAndLink = async function(clientId, invoiceId) {
      try {
        const routeOrder = parseInt(document.getElementById('routeOrder')?.value) || 1;
        const teamId = document.getElementById('teamSelect')?.value;

        if (!teamId) {
          showToast('error', 'Error', 'Please select a team');
          return;
        }

        const todayStr = toLocalDateString(new Date());

        // Create schedule
        const scheduleRef = await addDoc(collection(db, 'schedules'), {
          clientId: clientId,
          date: todayStr,
          teamId: teamId,
          routeOrder: routeOrder,
          status: 'scheduled',
          serviceDetails: {
            addOns: [],
            totalPrice: 0 // Will be calculated from invoice
          },
          createdAt: Timestamp.now(),
          createdBy: currentAdmin.id
        });

        // If there's pending invoice data, create the invoice now
        let createdInvoiceId = invoiceId;
        if (pendingInvoiceData) {
          const invoiceDataToCreate = {
            ...pendingInvoiceData.invoiceData,
            status: 'draft',
            createdAt: Timestamp.now(),
            createdBy: currentAdmin.id
          };

          const invoiceRef = await addDoc(collection(db, 'invoices'), invoiceDataToCreate);
          createdInvoiceId = invoiceRef.id;
          pendingInvoiceData = null; // Clear pending data
        }

        // Link invoice to schedule
        await updateDoc(doc(db, 'schedules', scheduleRef.id), {
          invoiceId: createdInvoiceId
        });

        showToast('success', 'Success', `${clients[clientId]?.firstName} added to schedule and invoice linked!`);

        // Reload and close
        await loadInvoices();
        await loadPayments();
        updateSummary();
        renderInvoices();
        renderPayments();

      } catch (error) {
        console.error('Error creating schedule:', error);
        showToast('error', 'Error', 'Failed to add to schedule');
      }
    };

    // ============================================
    // INVOICE TO SCHEDULE LINKING
    // ============================================
    let pendingLinkData = {};

    function showInvoiceScheduleLinkModal(schedules, invoiceId, clientId, invoiceDate) {
      const client = clients[clientId] || {};

      // Store data for the schedule selection
      pendingLinkData = { invoiceId, schedules };

      const modalContent = `
        <p style="margin: 0 0 16px 0; color: var(--gray-700);">
          Link this invoice to a scheduled job for ${client.firstName} ${client.lastName}?
        </p>

        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
          ${schedules.map(schedule => {
            const startTime = schedule.scheduledStartTime ? new Date(schedule.scheduledStartTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'TBD';
            return `
              <div
                onclick="linkInvoiceToSchedule('${invoiceId}', '${schedule.id}'); closeModal('linkInvoiceToScheduleModal');"
                style="padding: 12px; background: var(--primary-50); border: 1px solid var(--primary-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='var(--primary-100)'; this.style.borderColor='var(--primary-500)';"
                onmouseout="this.style.background='var(--primary-50)'; this.style.borderColor='var(--primary-300)';"
              >
                <div style="font-weight: 600; color: var(--primary-900); margin-bottom: 4px;">
                  Route #${schedule.routeOrder || 'TBD'} @ ${startTime}
                </div>
                <div style="font-size: 13px; color: var(--primary-700);">
                  Status: <span style="text-transform: capitalize;">${schedule.status}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('linkInvoiceToScheduleModal');"
          >
            Don't Link
          </button>
          <button
            type="button"
            class="btn btn-ghost"
            onclick="closeModal('linkInvoiceToScheduleModal');"
          >
            Skip for Now
          </button>
        </div>
      `;

      // Populate modal body
      document.getElementById('linkInvoiceToScheduleBody').innerHTML = modalContent;

      openModal('linkInvoiceToScheduleModal');
    }

    window.linkInvoiceToSchedule = async function(invoiceId, scheduleId) {
      try {
        await updateDoc(doc(db, 'schedules', scheduleId), {
          invoiceId: invoiceId
        });

        showToast('success', 'Linked', 'Invoice linked to schedule');
        await loadInvoices();
        await loadPayments();
        renderInvoices();
        renderPayments();
      } catch (error) {
        console.error('Error linking invoice to schedule:', error);
        showToast('error', 'Error', 'Failed to link invoice to schedule');
      }
    };

    window.viewInvoice = function(id) {
      currentInvoiceId = id;
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) return;

      const client = clients[invoice.clientId] || {};
      const invoiceDate = invoice.invoiceDate?.toDate ? invoice.invoiceDate.toDate() : new Date();
      const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date();

      document.getElementById('invoicePreviewContent').innerHTML = `
        <div class="invoice-preview">
          <div class="invoice-header">
            <div style="display: flex; align-items: center; gap: 12px;">
              <img src="images/logo.png" alt="Company Logo" style="height: 60px; width: 180px; object-fit: contain;">
              <div>
                <div class="invoice-logo" style="margin: 0;">${companyInfo?.name || 'Mendez Cleaning'}</div>
                <div class="text-gray-500 mt-2">${companyInfo?.tagline || 'Professional Cleaning Services'}</div>
              </div>
            </div>
            <div class="invoice-title">
              <h2>INVOICE</h2>
              <div class="invoice-number">${invoice.invoiceNumber}</div>
            </div>
          </div>

          <div class="invoice-parties">
            <div>
              <div class="invoice-party-label">From</div>
              <div class="invoice-party-name">${companyInfo?.name || 'Mendez Cleaning Services'}</div>
              <div class="invoice-party-details">
                ${companyInfo?.address || 'Your Business Address'}<br>
                ${companyInfo?.city || 'City'}, ${companyInfo?.state || 'State'} ${companyInfo?.zip || 'ZIP'}<br>
                Phone: ${companyInfo?.phone || '(555) 123-4567'}${companyInfo?.email ? `<br>Email: ${companyInfo.email}` : ''}
              </div>
            </div>
            <div>
              <div class="invoice-party-label">Bill To</div>
              <div class="invoice-party-name">${client.firstName || ''} ${client.lastName || ''}</div>
              <div class="invoice-party-details">
                ${client.address?.street || ''}<br>
                ${client.address?.city || ''}, ${client.address?.state || ''} ${client.address?.zip || ''}<br>
                ${client.email || ''}
              </div>
            </div>
          </div>
          
          <div class="invoice-meta">
            <div class="invoice-meta-item">
              <div class="invoice-meta-label">Invoice Date</div>
              <div class="invoice-meta-value">${formatDate(invoiceDate, { month: 'long', day: 'numeric', year: 'numeric' })}</div>
            </div>
            <div class="invoice-meta-item">
              <div class="invoice-meta-label">Due Date</div>
              <div class="invoice-meta-value">${formatDate(dueDate, { month: 'long', day: 'numeric', year: 'numeric' })}</div>
            </div>
          </div>
          
          <table class="invoice-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              ${(invoice.items || []).map(item => `
                <tr>
                  <td>${item.description}</td>
                  <td>${item.quantity}</td>
                  <td>${formatCurrency(item.rate)}</td>
                  <td>${formatCurrency(item.quantity * item.rate)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="invoice-totals">
            <div class="invoice-totals-table">
              <div class="invoice-totals-row">
                <span>Subtotal</span>
                <span>${formatCurrency(invoice.subtotal || 0)}</span>
              </div>
              <div class="invoice-totals-row">
                <span>Tax${invoice.taxPercentage ? ` (${invoice.taxPercentage}%)` : ''}</span>
                <span>${formatCurrency(invoice.tax || 0)}</span>
              </div>
              <div class="invoice-totals-row total">
                <span>Total</span>
                <span class="amount">${formatCurrency(invoice.total || 0)}</span>
              </div>
            </div>
          </div>
          
          ${invoice.notes ? `
            <div class="mb-6">
              <strong>Notes:</strong>
              <p class="text-gray-600 mt-1">${invoice.notes}</p>
            </div>
          ` : ''}
          
          <div class="invoice-footer">
            Thank you for your business!
          </div>
        </div>
      `;
      
      openModal('invoicePreviewModal');
    };

    window.deleteInvoice = async function(id) {
      const confirmed = await confirmDialog(
        i18n.t('delete'),
        'Are you sure you want to delete this invoice?',
        i18n.t('delete'),
        i18n.t('cancel')
      );

      if (!confirmed) return;

      try {
        // Remove invoiceId from linked schedules
        const schedulesSnap = await getDocs(
          query(collection(db, 'schedules'), where('invoiceId', '==', id))
        );

        for (const scheduleDoc of schedulesSnap.docs) {
          await updateDoc(scheduleDoc.ref, {
            invoiceId: null
          });
        }

        // Remove old payment records linked via invoiceId (backward compat)
        const linkedPayment = payments.find(p => p.invoiceId === id);
        if (linkedPayment) await deleteDoc(doc(db, 'payments', linkedPayment.id));

        await deleteDoc(doc(db, 'invoices', id));

        showToast('success', i18n.t('success'), 'Invoice deleted');
        await loadInvoices();
        await loadPayments();
        await loadSchedules();
        renderInvoices();
        renderPayments();
      } catch (error) {
        console.error('Error deleting invoice:', error);
        showToast('error', i18n.t('error'), 'Failed to delete invoice');
      }
    }; 

    async function generateInvoicePDF(invoice, client, returnBase64 = false, includeStatus = true) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const invoiceDate = invoice.invoiceDate?.toDate ? invoice.invoiceDate.toDate() : new Date(invoice.invoiceDate);
      const dueDate = invoice.dueDate?.toDate ? invoice.dueDate.toDate() : new Date(invoice.dueDate);

      // Colors
      const primaryColor = [79, 70, 229]; // Indigo
      const grayColor = [107, 114, 128];
      const darkColor = [31, 41, 55];
      const lightBgColor = [249, 250, 251];

      // === HEADER SECTION ===
      let yPos = 10;

      // Add logo image
      try {
        const response = await fetch('images/logo.png');
        if (response.ok) {
          const blob = await response.blob();
          const reader = new FileReader();
          await new Promise((resolve, reject) => {
            reader.onload = () => {
              const imgData = reader.result;
              const pageWidth = doc.internal.pageSize.getWidth();
              const logoHeight = 30; // Logo height in mm
              const logoWidth = 90; // Logo width in mm (3:1 aspect ratio)
              const xPos = (pageWidth - logoWidth) / 2; // Center horizontally
              doc.addImage(imgData, 'PNG', xPos, yPos, logoWidth, logoHeight);
              resolve();
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
          yPos += 35; // Adjust yPos to account for logo
        }
      } catch (error) {
        // Logo not found, continue without it
      }

      // Invoice label on right
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkColor);
      const pageWidth = doc.internal.pageSize.getWidth();
      doc.text('INVOICE', pageWidth - 20, 15, { align: 'center' });

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      doc.text('#' + invoice.invoiceNumber, pageWidth - 20, 22, { align: 'center' });

      yPos += 8;

      // === FROM AND BILL TO SECTIONS ===
      // From section
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...grayColor);
      doc.text('FROM', 20, yPos);

      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkColor);
      doc.text(companyInfo?.name || 'Mendez Cleaning Services', 20, yPos + 6);

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      let companyYPos = yPos + 12;
      doc.text(companyInfo?.address || 'Your Business Address', 20, companyYPos);
      doc.text(
        `${companyInfo?.city || 'City'}, ${companyInfo?.state || 'State'} ${companyInfo?.zip || 'ZIP'}`,
        20,
        companyYPos + 5
      );
      doc.text('Phone: ' + (companyInfo?.phone || '(555) 123-4567'), 20, companyYPos + 10);
      if (companyInfo?.email) {
        doc.text('Email: ' + companyInfo.email, 20, companyYPos + 15);
      }

      // Bill To section
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...grayColor);
      doc.text('BILL TO', 110, yPos);

      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkColor);
      doc.text(`${client.firstName || ''} ${client.lastName || ''}`, 110, yPos + 6);

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      let billYPos = yPos + 12;
      if (client.address?.street) {
        doc.text(client.address.street, 110, billYPos);
        billYPos += 5;
      }
      if (client.address?.city || client.address?.state || client.address?.zip) {
        doc.text(
          `${client.address?.city || ''}, ${client.address?.state || ''} ${client.address?.zip || ''}`,
          110,
          billYPos
        );
        billYPos += 5;
      }
      if (client.email) {
        doc.text(client.email, 110, billYPos);
        billYPos += 5;
      }
      if (client.phone) {
        doc.text(client.phone, 110, billYPos);
      }

      yPos += 35;

      // === INVOICE DETAILS BOX ===
      doc.setFillColor(...lightBgColor);
      const detailsBoxHeight = includeStatus ? 25 : 17;
      doc.rect(20, yPos, 170, detailsBoxHeight, 'F');

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      doc.text('Invoice Date:', 25, yPos + 7);
      doc.text('Due Date:', 25, yPos + 15);

      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkColor);
      doc.text(formatDate(invoiceDate, { month: 'long', day: 'numeric', year: 'numeric' }), 80, yPos + 7);
      doc.text(formatDate(dueDate, { month: 'long', day: 'numeric', year: 'numeric' }), 80, yPos + 15);

      // Status badge (only if includeStatus is true)
      if (includeStatus) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...grayColor);
        doc.text('Status:', 25, yPos + 23);

        const statusColors = { draft: [107, 114, 128], sent: [59, 130, 246], paid: [34, 197, 94], overdue: [239, 68, 68] };
        const statusColor = statusColors[invoice.status] || statusColors.draft;
        doc.setTextColor(...statusColor);
        doc.setFont('helvetica', 'bold');
        doc.text(invoice.status.toUpperCase(), 80, yPos + 23);
      }

      yPos += detailsBoxHeight + 7;

      // === ITEMS TABLE ===
      const tableTop = yPos;
      doc.setFillColor(...primaryColor);
      doc.rect(20, tableTop, 170, 8, 'F');

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('Description', 25, tableTop + 6);
      doc.text('Qty', 120, tableTop + 6);
      doc.text('Rate', 140, tableTop + 6);
      doc.text('Amount', 170, tableTop + 6);

      // Items
      doc.setTextColor(...darkColor);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      let itemY = tableTop + 14;

      (invoice.items || []).forEach((item, index) => {
        if (index % 2 === 0) {
          doc.setFillColor(...lightBgColor);
          doc.rect(20, itemY - 4, 170, 8, 'F');
        }
        doc.text(item.description || '', 25, itemY);
        doc.text(String(item.quantity || 0), 120, itemY);
        doc.text(formatCurrency(item.rate || 0), 140, itemY);
        doc.text(formatCurrency((item.quantity || 0) * (item.rate || 0)), 170, itemY);
        itemY += 8;
      });

      // === TOTALS SECTION ===
      yPos = itemY + 5;

      doc.setDrawColor(229, 231, 235);
      doc.line(120, yPos, 190, yPos);

      yPos += 6;

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      doc.text('Subtotal:', 140, yPos);
      doc.setTextColor(...darkColor);
      doc.setFont('helvetica', 'bold');
      doc.text(formatCurrency(invoice.subtotal || 0), 170, yPos);

      yPos += 7;

      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...grayColor);
      doc.text('Tax:', 140, yPos);
      doc.setTextColor(...darkColor);
      doc.setFont('helvetica', 'bold');
      doc.text(formatCurrency(invoice.tax || 0), 170, yPos);

      yPos += 8;

      doc.setDrawColor(...primaryColor);
      doc.setLineWidth(0.5);
      doc.line(120, yPos, 190, yPos);

      yPos += 8;

      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...primaryColor);
      doc.text('TOTAL:', 140, yPos);
      doc.text(formatCurrency(invoice.total || 0), 170, yPos);

      yPos += 12;

      // === NOTES SECTION ===
      if (invoice.notes) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...primaryColor);
        doc.text('Notes:', 20, yPos);

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...grayColor);
        doc.text(invoice.notes, 20, yPos + 6);

        yPos += 15;
      }

      // === FOOTER ===
      doc.setFillColor(...lightBgColor);
      doc.rect(0, 270, 220, 30, 'F');

      doc.setFontSize(10);
      doc.setTextColor(...grayColor);
      doc.setFont('helvetica', 'normal');
      doc.text('Thank you for your business!', 110, 282, { align: 'center' });

      doc.setFontSize(8);
      doc.text(`${companyInfo?.name || 'Mendez Cleaning'} - ${companyInfo?.tagline || 'Professional Cleaning Services'}`, 110, 288, { align: 'center' });

      if (returnBase64) {
        return doc.output('datauristring').split(',')[1];
      }
      return doc;
    }

    async function printInvoice() {
      const invoice = invoices.find(i => i.id === currentInvoiceId);
      if (!invoice) {
        showToast('error', 'Error', 'Invoice not found');
        return;
      }
      const client = clients[invoice.clientId] || {};
      const doc = await generateInvoicePDF(invoice, client, false, false);
      doc.autoPrint();
      window.open(doc.output('bloburl'), '_blank');
    }


    async function downloadInvoicePDF() {
      const invoice = invoices.find(i => i.id === currentInvoiceId);
      if (!invoice) {
        showToast('error', 'Error', 'Invoice not found');
        return;
      }
      const client = clients[invoice.clientId] || {};
      const doc = await generateInvoicePDF(invoice, client, false, false);
      doc.save(`Invoice-${invoice.invoiceNumber}.pdf`);
    }

    window.printInvoiceById = async function(id) {
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) {
        showToast('error', 'Error', 'Invoice not found');
        return;
      }
      const client = clients[invoice.clientId] || {};
      const pdfDoc = await generateInvoicePDF(invoice, client, false, false);
      pdfDoc.autoPrint();
      window.open(pdfDoc.output('bloburl'), '_blank');
    };

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function updateLanguage() {
      const lang = i18n.getLanguage();
      document.getElementById('langLabel').textContent = lang === 'en' ? 'ES' : 'EN';
      i18n.updatePageTranslations();
    }

    function getServiceSummary(client) {
      if (!client?.areas) return 'Standard';
      
      const floors = [];
      if (client.areas.basement?.includedInBase) floors.push('Basement');
      if (client.areas.mainLevel?.includedInBase) floors.push('Main');
      if (client.areas.upstairs?.includedInBase) floors.push('Upstairs');
      
      return floors.length > 0 ? floors.join('+') : 'Standard';
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    function openCompanySettings() {
      document.getElementById('settingsCompanyName').value = companyInfo?.name || 'Mendez Cleaning';
      document.getElementById('settingsTagline').value = companyInfo?.tagline || 'Professional Cleaning Services';
      document.getElementById('settingsPhone').value = companyInfo?.phone || '';
      document.getElementById('settingsEmail').value = companyInfo?.email || '';
      document.getElementById('settingsAddress').value = companyInfo?.address || '';
      document.getElementById('settingsCity').value = companyInfo?.city || '';
      document.getElementById('settingsState').value = companyInfo?.state || '';
      document.getElementById('settingsZip').value = companyInfo?.zip || '';
      document.getElementById('settingsEmailSubject').value = invoiceEmailTemplate?.subject || 'Invoice {invoiceNumber} from {companyName}';
      document.getElementById('settingsEmailMessage').value = invoiceEmailTemplate?.message || 'Please find attached your invoice. Payment is due within 7 days.';

      openModal('companySettingsModal');
    }

    async function saveCompanySettings() {
      const newCompanyInfo = {
        name: document.getElementById('settingsCompanyName').value.trim(),
        tagline: document.getElementById('settingsTagline').value.trim(),
        phone: document.getElementById('settingsPhone').value.trim(),
        email: document.getElementById('settingsEmail').value.trim(),
        address: document.getElementById('settingsAddress').value.trim(),
        city: document.getElementById('settingsCity').value.trim(),
        state: document.getElementById('settingsState').value.trim(),
        zip: document.getElementById('settingsZip').value.trim(),
        taxEnabled: document.getElementById('settingsTaxEnabled').checked,
        taxPercentage: parseFloat(document.getElementById('settingsTaxPercentage').value) || 0,
        updatedAt: Timestamp.now(),
        updatedBy: currentAdmin.id
      };

      const newEmailTemplate = {
        subject: document.getElementById('settingsEmailSubject').value.trim(),
        message: document.getElementById('settingsEmailMessage').value.trim(),
        updatedAt: Timestamp.now(),
        updatedBy: currentAdmin.id
      };

      try {
        await setDoc(doc(db, 'config', 'companyInfo'), newCompanyInfo);
        await setDoc(doc(db, 'config', 'invoiceEmailTemplate'), newEmailTemplate);

        companyInfo = newCompanyInfo;
        invoiceEmailTemplate = newEmailTemplate;

        showToast('success', 'Success', 'Company settings saved');
        closeModal('companySettingsModal');
      } catch (error) {

        showToast('error', 'Error', 'Failed to save settings');
      }
    }

    function setupEventListeners() {
      // Mobile menu
      document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebarOverlay').classList.toggle('active');
      });

      document.getElementById('sidebarOverlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
      });

      // Language
      document.getElementById('langToggle').addEventListener('click', () => {
        i18n.toggleLanguage();
        updateLanguage();
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
      });

      // Date range buttons
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.addEventListener('click', () => setDateRange(btn.dataset.range));
      });

      document.getElementById('applyDateRange').addEventListener('click', () => {
        startDate = new Date(document.getElementById('startDate').value);
        endDate = new Date(document.getElementById('endDate').value);
        endDate.setHours(23, 59, 59, 999);
        loadData();
      });

      // Tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
        });
      });

      // Filters
      document.getElementById('paymentStatusFilter').addEventListener('change', renderPayments);
      document.getElementById('expenseCategoryFilter').addEventListener('change', renderExpenses);
      document.getElementById('invoiceStatusFilter').addEventListener('change', renderInvoices);

      // Expense Modal
      document.getElementById('addExpenseBtn').addEventListener('click', openExpenseModal);
      document.getElementById('addFirstExpenseBtn')?.addEventListener('click', openExpenseModal);
      document.getElementById('closeExpenseModal').addEventListener('click', () => closeModal('expenseModal'));
      document.getElementById('cancelExpenseBtn').addEventListener('click', () => closeModal('expenseModal'));
      document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
      
      document.getElementById('expenseRecurring').addEventListener('change', (e) => {
        document.getElementById('recurringOptions').classList.toggle('hidden', !e.target.checked);
      });

      // Payment Modal
      document.getElementById('closePaymentModal').addEventListener('click', () => closeModal('paymentModal'));
      document.getElementById('cancelPaymentBtn').addEventListener('click', () => closeModal('paymentModal'));
      document.getElementById('savePaymentBtn').addEventListener('click', savePayment);

      //Render Payments
      document.getElementById('paymentSourceFilter')?.addEventListener('change', renderPayments);
      document.getElementById('completedJobsFilter')?.addEventListener('change', renderCompletedJobs);

      // Invoice Modal
      document.getElementById('createInvoiceBtn').addEventListener('click', openInvoiceModal);
      document.getElementById('createFirstInvoiceBtn')?.addEventListener('click', openInvoiceModal);
      document.getElementById('closeInvoiceModal').addEventListener('click', () => closeModal('invoiceModal'));
      document.getElementById('cancelInvoiceBtn').addEventListener('click', () => closeModal('invoiceModal'));
      document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
      document.getElementById('addInvoiceItemBtn').addEventListener('click', addInvoiceItem);
      document.getElementById('invoiceClient').addEventListener('change', onClientSelect);
      document.getElementById('invoiceTaxEnabled').addEventListener('change', updateInvoiceTotals);
      document.getElementById('invoiceTaxPercentage').addEventListener('input', updateInvoiceTotals);

      // Quick Add Schedule Modal
      document.getElementById('closeQuickAddScheduleModal').addEventListener('click', () => closeModal('quickAddScheduleModal'));
      document.getElementById('cancelQuickAddScheduleBtn').addEventListener('click', () => closeModal('quickAddScheduleModal'));
      document.getElementById('confirmQuickAddScheduleBtn').addEventListener('click', () => {
        quickCreateScheduleAndLink(pendingScheduleData.clientId, pendingScheduleData.invoiceId);
        closeModal('quickAddScheduleModal');
      });

      // Link Invoice to Schedule Modal
      document.getElementById('closeLinkInvoiceToScheduleModal').addEventListener('click', () => closeModal('linkInvoiceToScheduleModal'));
      document.getElementById('cancelLinkInvoiceBtn').addEventListener('click', () => closeModal('linkInvoiceToScheduleModal'));

      // Invoice Preview
      document.getElementById('closePreviewModal').addEventListener('click', () => closeModal('invoicePreviewModal'));
      document.getElementById('closePreviewBtn').addEventListener('click', () => closeModal('invoicePreviewModal'));
      document.getElementById('printInvoiceBtn').addEventListener('click', printInvoice);

      // Send Invoice Modal
      document.getElementById('closeSendInvoiceModal')?.addEventListener('click', () => closeModal('sendInvoiceModal'));
      document.getElementById('cancelSendInvoiceBtn')?.addEventListener('click', () => closeModal('sendInvoiceModal'));
      document.getElementById('confirmSendInvoiceBtn')?.addEventListener('click', confirmSendInvoice);
      document.getElementById('sendInvoiceBtn')?.addEventListener('click', () => {
        if (currentInvoiceId) { closeModal('invoicePreviewModal'); sendInvoice(currentInvoiceId); }
      });

      document.getElementById('sendInvoiceBtn').addEventListener('click', () => {
        if (currentInvoiceId) {
          closeModal('invoicePreviewModal');
          sendInvoice(currentInvoiceId);
        }
      });

      // Company Settings Modal
      document.getElementById('companySettingsBtn').addEventListener('click', openCompanySettings);
      document.getElementById('saveSettingsBtn').addEventListener('click', saveCompanySettings);
      document.getElementById('cancelSettingsBtn').addEventListener('click', () => closeModal('companySettingsModal'));
      document.getElementById('closeCompanySettingsModal').addEventListener('click', () => closeModal('companySettingsModal'));

      // Modal backdrop
      document.getElementById('modalBackdrop').addEventListener('click', closeAllModals);
    }
  </script>
</body>
</html>